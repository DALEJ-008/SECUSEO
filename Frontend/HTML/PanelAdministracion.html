<!DOCTYPE html>
{% load static %}
<html lang="es"><head>
<meta charset="utf-8"/>
<link crossorigin="" href="https://fonts.gstatic.com/" rel="preconnect"/>
<link as="style" href="https://fonts.googleapis.com/css2?display=swap&amp;family=Poppins%3Awght%40400%3B500%3B600%3B700&amp;family=Noto+Sans%3Awght%40400%3B500%3B700%3B900" onload="this.rel='stylesheet'" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
<title>Panel de Administración- SECUSEO</title>


<link href="data:image/x-icon;base64," rel="icon" type="image/x-icon"/>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>

  <style type="text/tailwindcss">
      :root {
        --primary-color: #545dfa;
        --secondary-color: #f1f2ff;
        --text-primary: #111827;
        --text-secondary: #6b7280;
        --border-color: #e5e7eb;
      }
      body {
        font-family: 'Poppins', sans-serif;
      }
      .active-nav {
        color: var(--primary-color);
        font-weight: 600;
        border-bottom: 2px solid var(--primary-color);
      }
    </style>
</head>
<body class="bg-[#f1f2ff] text-[var(--text-primary)]">
<div class="relative flex min-h-screen w-full flex-col group/design-root overflow-x-hidden">
<div class="layout-container flex h-full grow flex-col">
<header class="flex items-center justify-between whitespace-nowrap border-b border-solid border-[var(--border-color)] bg-white px-10 py-4 shadow-sm">
<div class="flex items-center gap-3 text-text-primary">
          <img alt="SECUSEO Logo" class="h-12 w-auto" id="site-logo" src="{% static 'HTML/Logo2.png' %}">
        </div>
<nav class="hidden md:flex flex-1 justify-center gap-8">
<a class="text-gray-600 hover:text-[var(--primary-color)] text-sm font-medium leading-normal py-2 transition-colors duration-200" href="#" data-target="top-dashboard">Dashboard</a>
<a class="text-sm font-medium leading-normal py-2 transition-colors duration-200 active-nav" href="#" data-target="reports-section">Reportes</a>
<a class="text-gray-600 hover:text-[var(--primary-color)] text-sm font-medium leading-normal py-2 transition-colors duration-200" href="#" data-target="users-section">Usuarios</a>
<a class="text-gray-600 hover:text-[var(--primary-color)] text-sm font-medium leading-normal py-2 transition-colors duration-200" href="#" data-target="comms-section">Comunicados</a>
</nav>
<div class="flex items-center gap-4">
                    <!-- Notifications dropdown -->
                    <div class="relative">
                      <button id="btn-notifications" class="relative rounded-full p-2 text-text-secondary hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-color">
                        <span class="material-symbols-outlined">notifications</span>
                        <span id="notif-badge" class="absolute -top-1 -right-1 hidden inline-flex items-center justify-center rounded-full bg-red-500 text-white text-xs w-5 h-5">0</span>
                      </button>
                      <div id="dropdown-notifications" class="hidden absolute right-0 mt-2 w-80 bg-white border border-[var(--border-color)] rounded-md shadow-lg z-50">
                        <div class="p-3 text-sm font-semibold">Notificaciones</div>
                        <div id="notif-list" class="max-h-56 overflow-auto divide-y"></div>
                        <div class="p-2 text-center text-xs text-gray-500">No disponibles</div>
                      </div>
                    </div>

                    <!-- Profile dropdown -->
                    <div class="relative">
                      <button id="btn-profile" class="flex items-center gap-2">
                        <div id="profile-photo" class="bg-center bg-no-repeat aspect-square bg-cover rounded-full w-9 h-9" style="background-image: url({% static 'HTML/Logo3.png' %});"></div>
                        <span id="profile-arrow" class="material-symbols-outlined text-text-secondary">expand_more</span>
                      </button>
                      <div id="dropdown-profile" class="hidden absolute right-0 mt-2 w-56 bg-white border border-[var(--border-color)] rounded-md shadow-lg z-50">
                        <div class="p-3">
                          <div id="profile-username" class="font-medium">Usuario</div>
                          <div id="profile-email" class="text-xs text-gray-500">email@example.com</div>
                        </div>
                        <div class="divide-y">
                          <div class="p-2">
                            <a href="/" class="block p-2 rounded hover:bg-gray-50">Página principal</a>
                            <button id="btn-view-profile" class="w-full text-left p-2 rounded hover:bg-gray-50">Ver perfil</button>
                          </div>
                          <div class="p-2">
                            <a id="btn-admin-panel" href="/admin-panel/" class="block p-2 rounded hover:bg-gray-50 hidden">Panel de Administración</a>
                            <button id="btn-logout" class="block w-full text-left p-2 rounded hover:bg-gray-50">Cerrar sesión</button>
                          </div>
                        </div>
                      </div>
                    </div>
                </div>
            </header>
<main class="flex-1 px-4 sm:px-6 lg:px-8 py-8">
<div class="mx-auto max-w-7xl">
<div class="mb-8">
<h1 class="text-3xl font-bold tracking-tight text-slate-900">Panel de Administración</h1>
<p class="text-gray-500 mt-1">Bienvenido, gestiona la aplicación desde aquí.</p>
</div>
<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
<div class="flex flex-col gap-2 rounded-lg p-6 bg-white border border-[var(--border-color)] shadow-sm">
<p class="text-[var(--text-secondary)] text-sm font-medium">Reportes Pendientes</p>
<p class="text-3xl font-bold text-slate-900"><span id="count-pending">0</span></p>
</div>
<div class="flex flex-col gap-2 rounded-lg p-6 bg-white border border-[var(--border-color)] shadow-sm">
<p class="text-[var(--text-secondary)] text-sm font-medium">Usuarios Totales</p>
<p class="text-3xl font-bold text-slate-900"><span id="count-users">0</span></p>
</div>
<div class="flex flex-col gap-2 rounded-lg p-6 bg-white border border-[var(--border-color)] shadow-sm">
<p class="text-[var(--text-secondary)] text-sm font-medium">Comunicados Recientes</p>
<p class="text-3xl font-bold text-slate-900"><span id="count-comms">0</span></p>
</div>
</div>
<div class="space-y-12">
<div id="reports-section" class="bg-white border border-[var(--border-color)] rounded-lg shadow-sm overflow-hidden">
<div class="px-6 py-4 border-b border-[var(--border-color)]">
<h2 class="text-lg font-semibold text-slate-900">Gestión de Reportes</h2>
</div>
<div class="overflow-x-auto">
<table class="min-w-full divide-y divide-[#eef5ff]">
<thead class="bg-[#eef5ff]">
<tr>
<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" scope="col">Reporte ID</th>
<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" scope="col">Ubicación</th>
<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" scope="col">Descripción</th>
<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" scope="col">Estado</th>
<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" scope="col">Acciones</th>
</tr>
</thead>
<tbody class="bg-white divide-y divide-[var(--border-color)]" id="reports-tbody">
<!-- report rows will be loaded dynamically -->
</tbody>
</table>
</div>
</div>
<div id="users-section" class="bg-white border border-[var(--border-color)] rounded-lg shadow-sm overflow-hidden">
<div class="px-6 py-4 border-b border-[var(--border-color)]">
<h2 class="text-lg font-semibold text-slate-900">Gestión de Usuarios</h2>
</div>
<div class="overflow-x-auto">
<table class="min-w-full divide-y divide-[#eef5ff]">
<thead class="bg-[#eef5ff]">
<tr>
<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" scope="col">User ID</th>
<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" scope="col">Nombre</th>
<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" scope="col">Email</th>
<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" scope="col">Rol</th>
<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" scope="col">Acciones</th>
</tr>
</thead>
<tbody class="bg-white divide-y divide-[var(--border-color)]" id="users-tbody">
<!-- users will be loaded dynamically -->
</tbody>
</table>
</div>
</div>
<div id="comms-section" class="bg-white border border-[var(--border-color)] rounded-lg shadow-sm">
<div class="px-6 py-4 border-b border-[var(--border-color)]">
<h2 class="text-lg font-semibold text-slate-900">Comunicados</h2>
</div>
<div class="p-6">
<div class="flex flex-col gap-4">
<label class="sr-only" for="communication">Escribe tu comunicado aquí...</label>
<textarea class="form-textarea block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm min-h-36" id="communication" placeholder="Escribe tu comunicado aquí..."></textarea>
<div class="flex justify-end">
<button id="btn-send-comunicado" class="inline-flex items-center justify-center rounded-md border border-transparent bg-[var(--primary-color)] px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-opacity-90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[var(--primary-color)]">
<span class="material-symbols-outlined mr-2 -ml-1">send</span>
                                Enviar a la comunidad
                            </button>
</div>
</div>
</div>
</div>
</div>
</div>

<script>
// Admin dashboard JS: fetch pending reports and render into the table
async function fetchPending() {
  try {
  const res = await fetch('/admin/api/reportes/pending/');
    if (!res.ok) throw new Error('error fetching');
    const data = await res.json();
  const reportSection = document.getElementById('reports-tbody');
  reportSection.innerHTML = '';
    let count = 0;
    data.reportes.forEach(r => {
      count += 1;
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-900">#${r.id}</td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-[var(--text-secondary)]">${r.ubicacion || (r.coordenadas ? r.coordenadas.join(',') : '—')}</td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-[var(--text-secondary)]">${(r.descripcion || '').slice(0,120)}</td>
        <td class="px-6 py-4 whitespace-nowrap text-sm"><span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800"> Pendiente </span></td>
        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
          <button data-id="${r.id}" class="view text-blue-600 hover:text-blue-900">Ver</button>
          <button data-id="${r.id}" class="approve text-green-600 hover:text-green-900">Aprobar</button>
          <button data-id="${r.id}" class="reject text-red-600 hover:text-red-900">Eliminar</button>
        </td>
      `;
      reportSection.appendChild(tr);
    });
    // update the counter card
  const card = document.querySelectorAll('.grid div')[0];
    if (card) {
      const p = card.querySelectorAll('p')[1];
      if (p) p.textContent = count;
    }
    attachActions();
  } catch (err) {
    console.error(err);
  }
}

function attachActions(){
  document.querySelectorAll('button.approve').forEach(btn=>{
    btn.onclick = async (e)=>{
      const id = e.target.dataset.id;
      if(!confirm('Aprobar reporte #' + id + '?')) return;
  const res = await fetch(`/admin/api/reportes/${id}/validar/`, {method: 'POST', headers: {'X-CSRFToken': getCookie('csrftoken')}});
      if(res.ok) fetchPending(); else alert('Error al aprobar');
    }
  });
  document.querySelectorAll('button.reject').forEach(btn=>{
    btn.onclick = async (e)=>{
      const id = e.target.dataset.id;
      if(!confirm('Rechazar/eliminar reporte #' + id + '?')) return;
  const res = await fetch(`/admin/api/reportes/${id}/rechazar/`, {method: 'POST', headers: {'X-CSRFToken': getCookie('csrftoken')}});
      if(res.ok) fetchPending(); else alert('Error al rechazar');
    }
  });
}

function getCookie(name) {
  const value = `; ${document.cookie}`;
  const parts = value.split(`; ${name}=`);
  if (parts.length === 2) return parts.pop().split(';').shift();
}

document.addEventListener('DOMContentLoaded', ()=>{
  fetchPending();
  // refresh every 60s
  setInterval(fetchPending, 60000);
  fetchUsers();
  setInterval(fetchUsers, 120000);
  fetchCounts();
  setInterval(fetchCounts, 60000);
  // smooth scroll for nav
  document.querySelectorAll('nav a[data-target]').forEach(a=>{
    a.addEventListener('click', (e)=>{
      e.preventDefault();
      const id = a.getAttribute('data-target');
      const el = document.getElementById(id);
      if(el){
        el.scrollIntoView({behavior: 'smooth', block: 'start'});
      }
    });
  });
});

// ---------- Notifications & Profile dropdown logic ----------
async function fetchWhoami(){
  try{
    const res = await fetch('/api/whoami/');
    if(!res.ok) return;
    const data = await res.json();
    if(data.ok){
      const pu = document.getElementById('profile-username');
      const pe = document.getElementById('profile-email');
      const pp = document.getElementById('profile-photo');
      if(pu) pu.textContent = data.username || data.email || 'Usuario';
      if(pe) pe.textContent = data.email || '';
      if(pp && data.photo_url) pp.style.backgroundImage = `url(${data.photo_url})`;
      if(data.role === 'admin'){ const bap = document.getElementById('btn-admin-panel'); if(bap) bap.classList.remove('hidden'); }
    }
  }catch(e){console.error('whoami',e)}
}

async function loadNotifications(){
  try{
    const res = await fetch('/api/notificaciones/');
    if(!res.ok) return;
    const d = await res.json();
    const list = document.getElementById('notif-list');
    list.innerHTML = '';
    let unread = 0;
    (d.notificaciones || []).forEach(n=>{
      const div = document.createElement('div');
      div.className = 'p-2 cursor-pointer hover:bg-gray-50';
      div.dataset.id = n.id;
      div.innerHTML = `<div class="font-medium text-sm">${n.titulo}</div><div class="text-xs text-gray-500">${n.resumen}</div>`;
      if(!n.leida) unread += 1;
      div.onclick = async ()=>{
        // mark read and open detail
        await fetch(`/api/notificaciones/${n.id}/leer/`, {method:'POST', headers: {'X-CSRFToken': getCookie('csrftoken')}});
        const rr = await fetch(`/api/notificaciones/${n.id}/detail/`);
        if(!rr.ok) return alert('No se pudo cargar la notificación');
        const detail = await rr.json();
        alert(detail.titulo + '\n\n' + detail.cuerpo);
        // refresh
        loadNotifications();
      };
      list.appendChild(div);
    });
    const badge = document.getElementById('notif-badge');
    if(unread>0){ badge.textContent = unread; badge.classList.remove('hidden'); } else { badge.classList.add('hidden'); }
  }catch(e){console.error('load notis',e)}
}

document.addEventListener('click', (ev)=>{
  // notifications toggle
  const btn = document.getElementById('btn-notifications');
  const dropdown = document.getElementById('dropdown-notifications');
  if(btn && btn.contains(ev.target)){
    dropdown.classList.toggle('hidden');
    if(!dropdown.classList.contains('hidden')) loadNotifications();
    return;
  }
  if(dropdown && !dropdown.contains(ev.target)) dropdown.classList.add('hidden');

  // profile toggle
  const pbtn = document.getElementById('btn-profile');
  const pdrop = document.getElementById('dropdown-profile');
  if(pbtn && pbtn.contains(ev.target)){
    pdrop.classList.toggle('hidden');
    return;
  }
  if(pdrop && !pdrop.contains(ev.target)) pdrop.classList.add('hidden');
});

// wire profile actions
document.getElementById('btn-view-profile').addEventListener('click', ()=>{
  alert('Perfil:\n' + document.getElementById('profile-username').textContent + '\n' + document.getElementById('profile-email').textContent + '\n\nPara editar tu nombre o foto, usa la opción de edición en la página de perfil (próxima mejora).');
});

// initial whoami
fetchWhoami();

// logout handler (guarded)
const logoutBtn = document.getElementById('btn-logout');
if(logoutBtn){ logoutBtn.addEventListener('click', ()=>{ window.location.href = '/logout/'; }); }

// send comunicado button
document.getElementById('btn-send-comunicado').addEventListener('click', async ()=>{
  const text = document.getElementById('communication').value || '';
  if(!text.trim()) return alert('Escribe un comunicado antes de enviar');
  const fd = new FormData(); fd.append('title', text.slice(0,80)); fd.append('body', text);
  const res = await fetch('/api/comunicado/create/', {method:'POST', headers: {'X-CSRFToken': getCookie('csrftoken')}, body: fd});
  if(res.ok){ alert('Comunicado enviado'); document.getElementById('communication').value = ''; fetchCounts(); } else { alert('Error al enviar comunicado'); }
});

// Notification detail modal
const notifModalHtml = `
<div id="notif-modal" class="fixed inset-0 z-60 hidden items-center justify-center bg-black bg-opacity-50">
  <div class="bg-white rounded-lg w-11/12 max-w-2xl p-4 shadow-lg border border-[var(--border-color)]">
    <div class="flex justify-between items-start">
      <h3 id="notif-modal-title" class="text-lg font-semibold">Notificación</h3>
      <button id="notif-modal-close" class="text-gray-500">Cerrar</button>
    </div>
    <div class="mt-3" id="notif-modal-body"></div>
  </div>
</div>
`;
document.body.insertAdjacentHTML('beforeend', notifModalHtml);

// Profile edit modal
const profileEditHtml = `
<div id="profile-edit-modal" class="fixed inset-0 z-60 hidden items-center justify-center bg-black bg-opacity-50">
  <div class="bg-white rounded-lg w-11/12 max-w-lg p-4 shadow-lg border border-[var(--border-color)]">
    <div class="flex justify-between items-start">
      <h3 class="text-lg font-semibold">Editar Perfil</h3>
      <button id="profile-edit-close" class="text-gray-500">Cerrar</button>
    </div>
    <div class="mt-3 space-y-3">
      <div>
        <label class="text-sm font-medium">Nombre de usuario</label>
        <input id="profile-edit-username" class="block w-full mt-1 rounded border-gray-200" />
      </div>
      <div>
        <label class="text-sm font-medium">Foto de perfil</label>
        <input id="profile-edit-photo" type="file" accept="image/*" class="block mt-1" />
      </div>
      <div class="flex justify-end">
        <button id="profile-edit-save" class="inline-flex items-center justify-center rounded-md border border-transparent bg-[var(--primary-color)] px-4 py-2 text-sm font-medium text-white">Guardar</button>
      </div>
    </div>
  </div>
</div>
`;
document.body.insertAdjacentHTML('beforeend', profileEditHtml);

// notification click handler (replace alert with modal)
async function showNotificationDetail(id){
  const rr = await fetch(`/api/notificaciones/${id}/detail/`);
  if(!rr.ok) return alert('No se pudo cargar la notificación');
  const detail = await rr.json();
  document.getElementById('notif-modal-title').textContent = detail.titulo || 'Notificación';
  document.getElementById('notif-modal-body').textContent = detail.cuerpo || '';
  const m = document.getElementById('notif-modal'); m.classList.remove('hidden'); m.classList.add('flex');
}

document.addEventListener('click', (ev)=>{
  const nmClose = document.getElementById('notif-modal-close');
  if(nmClose && nmClose.contains(ev.target)){
    const m = document.getElementById('notif-modal'); m.classList.remove('flex'); m.classList.add('hidden');
  }
  const pmClose = document.getElementById('profile-edit-close');
  if(pmClose && pmClose.contains(ev.target)){
    const m = document.getElementById('profile-edit-modal'); m.classList.remove('flex'); m.classList.add('hidden');
  }
});

// override earlier notification click behavior to use modal + mark read
// we attach a delegated handler on notif-list
document.getElementById('notif-list').addEventListener('click', async (e)=>{
  let el = e.target;
  while(el && !el.dataset.id) el = el.parentElement;
  if(!el || !el.dataset.id) return;
  const id = el.dataset.id;
  await fetch(`/api/notificaciones/${id}/leer/`, {method:'POST', headers: {'X-CSRFToken': getCookie('csrftoken')}});
  await showNotificationDetail(id);
  loadNotifications();
});

// profile edit open (may not exist in dropdowns anymore)
const btnEditProfile = document.getElementById('btn-edit-profile');
if(btnEditProfile){
  btnEditProfile.addEventListener('click', async ()=>{
    const username = document.getElementById('profile-username').textContent || '';
    const input = document.getElementById('profile-edit-username');
    if(input) input.value = username;
    const m = document.getElementById('profile-edit-modal'); if(m){ m.classList.remove('hidden'); m.classList.add('flex'); }
  });
}

// profile edit save (guard)
const profileEditSave = document.getElementById('profile-edit-save');
if(profileEditSave){
  profileEditSave.addEventListener('click', async ()=>{
    const fd = new FormData();
    const username = (document.getElementById('profile-edit-username') || {}).value;
    if(username) fd.append('username', username);
    const photoEl = document.getElementById('profile-edit-photo');
    const photo = photoEl && photoEl.files ? photoEl.files[0] : null;
    if(photo) fd.append('photo', photo);
    const res = await fetch('/api/profile/update/', {method:'POST', headers: {'X-CSRFToken': getCookie('csrftoken')}, body: fd});
    if(res.ok){ const d = await res.json(); if(d.photo_url) { const pp = document.getElementById('profile-photo'); if(pp) pp.style.backgroundImage = `url(${d.photo_url})`; } const pu = document.getElementById('profile-username'); if(pu) pu.textContent = d.username; alert('Perfil actualizado'); const m = document.getElementById('profile-edit-modal'); if(m){ m.classList.remove('flex'); m.classList.add('hidden'); } } else { alert('Error al actualizar perfil'); }
  });
}

// Users
async function fetchUsers(){
  try{
  const res = await fetch('/admin/api/users/');
    if(!res.ok) throw new Error('error fetching users');
    const data = await res.json();
    const tbody = document.getElementById('users-tbody');
    tbody.innerHTML = '';
    data.users.forEach(u=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-900">#U${u.id}</td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-[var(--text-secondary)]">${u.nombre || u.username}</td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-[var(--text-secondary)]">${u.email}</td>
        <td class="px-6 py-4 whitespace-nowrap text-sm"><span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${u.role==='admin' ? 'bg-purple-100 text-purple-800' : 'bg-blue-100 text-blue-800'}"> ${u.role.charAt(0).toUpperCase()+u.role.slice(1)} </span></td>
        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
          <button data-id="${u.id}" data-role="${u.role}" class="edit-user text-indigo-600 hover:text-indigo-900">Editar</button>
          <button data-id="${u.id}" class="delete-user text-red-600 hover:text-red-900">Eliminar</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
    attachUserActions();
    // update user count card
    const card = document.querySelectorAll('.grid div')[1];
    if (card) {
      const p = card.querySelectorAll('p')[1];
      if (p) p.textContent = data.users.length;
    }
  }catch(err){console.error(err)}
}

async function fetchCounts(){
  try{
    const res = await fetch('/admin/api/counts/');
    if(!res.ok) return;
    const d = await res.json();
    document.getElementById('count-pending').textContent = d.pending_reportes;
    document.getElementById('count-users').textContent = d.users_total;
    document.getElementById('count-comms').textContent = d.comunicados_recientes;
  }catch(e){console.error('count fetch',e)}
}

function attachUserActions(){
  document.querySelectorAll('button.edit-user').forEach(btn=>{
    btn.onclick = async (e)=>{
      const id = e.target.dataset.id;
      const current = e.target.dataset.role;
      const newRole = prompt('Asignar rol a usuario (admin/user/moderator):', current);
      if(!newRole) return;
      const fd = new FormData(); fd.append('role', newRole);
  const res = await fetch(`/admin/api/users/${id}/set-role/`, {method:'POST', headers: {'X-CSRFToken': getCookie('csrftoken')}, body: fd});
      if(res.ok) fetchUsers(); else alert('Error al cambiar rol');
    }
  });
  document.querySelectorAll('button.delete-user').forEach(btn=>{
    btn.onclick = async (e)=>{
      const id = e.target.dataset.id;
      if(!confirm('Eliminar usuario #' + id + '?')) return;
  const res = await fetch(`/admin/api/users/${id}/delete/`, {method:'POST', headers: {'X-CSRFToken': getCookie('csrftoken')}});
      if(res.ok) fetchUsers(); else alert('Error al eliminar');
    }
  });
}
</script>

<!-- Modal for viewing report -->
<div id="report-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black bg-opacity-40">
  <div class="bg-white rounded-xl max-w-5xl w-full mx-4 md:mx-0 p-6 shadow-2xl border border-[var(--border-color)]">
    <div class="flex items-start justify-between mb-4">
      <div>
        <h3 class="text-2xl font-semibold">Detalle del Reporte <span id="modal-report-id" class="text-gray-500 text-base font-normal"></span></h3>
        <p class="text-sm text-gray-500 mt-1">Información completa del reporte seleccionado</p>
      </div>
      <div class="flex items-center gap-3">
        <button id="modal-close" class="text-gray-500 hover:text-gray-700">Cerrar</button>
      </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
      <div class="md:col-span-2">
        <div class="mb-4">
          <p id="modal-ubicacion" class="text-sm text-gray-600 font-medium"></p>
          <p id="modal-descripcion" class="mt-3 text-base text-gray-700"></p>
        </div>

        <div class="grid grid-cols-2 gap-4 mt-4 text-sm text-gray-600">
          <div class="flex items-center gap-3">
            <div class="text-xs text-gray-500 w-28">Tipo</div>
            <div id="modal-tipo" class="text-sm font-medium text-gray-800"></div>
          </div>

          <div class="flex items-center gap-3">
            <div class="text-xs text-gray-500 w-28">Prioridad</div>
            <div id="modal-prioridad" class="text-sm font-medium"></div>
          </div>

          <div class="flex items-center gap-3">
            <div class="text-xs text-gray-500 w-28">Estado</div>
            <div id="modal-estado" class="text-sm font-medium text-gray-700"></div>
          </div>

          <div class="flex items-center gap-3">
            <div class="text-xs text-gray-500 w-28">Creado por</div>
            <div id="modal-creado" class="text-sm font-medium text-gray-700"></div>
          </div>
        </div>

        <div class="mt-6 flex gap-3">
          <button id="modal-approve" class="inline-flex items-center gap-2 h-10 px-4 rounded-md bg-green-600 text-white text-sm font-medium shadow-sm hover:bg-green-700">Aprobar</button>
          <button id="modal-reject" class="inline-flex items-center gap-2 h-10 px-4 rounded-md bg-red-50 text-red-600 text-sm font-medium border border-red-100 hover:bg-red-100">Rechazar</button>
          <button id="modal-delete" style="display:none" class="inline-flex items-center gap-2 h-10 px-4 rounded-md bg-red-700 text-white text-sm font-medium shadow-sm hover:bg-red-800">Eliminar permanentemente</button>
        </div>
      </div>

      <div class="md:col-span-1">
        <div id="modal-map" class="w-full rounded-md overflow-hidden shadow-sm" style="height:200px; border:1px solid #e5e7eb;"></div>
        <div id="modal-image" class="mt-4 rounded-md overflow-hidden border border-[var(--border-color)] p-2 bg-white"></div>
      </div>
    </div>
  </div>
</div>

<!-- Leaflet CSS/JS for mini map -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="" crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="" crossorigin=""></script>

<script>
function attachViewActions(){
  document.querySelectorAll('button.view').forEach(btn=>{
    btn.onclick = async (e)=>{
      const id = e.target.dataset.id;
      const res = await fetch(`/admin/api/reportes/${id}/detail/`);
      if(!res.ok){ alert('No se pudo cargar el detalle'); return; }
      const d = await res.json();
      document.getElementById('modal-report-id').textContent = '#'+d.id;
      document.getElementById('modal-ubicacion').textContent = d.ubicacion || '';
      document.getElementById('modal-descripcion').textContent = d.descripcion || '';
      // Friendly labels for 'tipo' values
      const TYPE_LABELS = {
        'robo': 'Robo',
        'asalto': 'Asalto',
        'hurto': 'Hurto',
        'vandalismo': 'Vandalismo',
        'iluminacion': 'Poca Iluminación',
        'accidente': 'Accidente de Tránsito',
        'violencia': 'Violencia',
        'consumo_drogas': 'Consumo/Venta de Drogas',
        'incendio': 'Incendio',
        'amenaza': 'Amenaza',
        'robo_vehiculo': 'Robo de Vehículos',
        'acoso_callejero': 'Acoso Callejero',
        'prostitucion_ilegal': 'Prostitución Ilegal',
        'fraude_estafa': 'Fraudes y Estafas',
        'otro': 'Otro'
      };
      const tipoKey = (d.tipo || '').toString().trim();
      const prettyTipo = TYPE_LABELS[tipoKey] || tipoKey || '—';
      document.getElementById('modal-tipo').textContent = prettyTipo;

      function mapPriorityToLevel(p){
        if(!p) return 'Bajo';
        const s = String(p).toLowerCase();
        if(s.includes('alto') || s.includes('3') || s.includes('3.0')) return 'Alto';
        if(s.includes('medio') || s.includes('2') || s.includes('2.0')) return 'Medio';
        if(s.includes('asalto') || s.includes('violencia') || s.includes('robo')) return 'Alto';
        if(s.includes('ilumin') || s.includes('iluminacion') || s.includes('hurto') || s.includes('vandal')) return 'Medio';
        return 'Bajo';
      }
      const level = mapPriorityToLevel(d.prioridad || d.tipo || '');
      // Render colored badge
      const badge = document.createElement('span');
      badge.className = 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium';
      if(level === 'Alto') { badge.classList.add('bg-red-100','text-red-800'); badge.textContent = 'Alto'; }
      else if(level === 'Medio') { badge.classList.add('bg-yellow-100','text-yellow-800'); badge.textContent = 'Medio'; }
      else { badge.classList.add('bg-green-100','text-green-800'); badge.textContent = 'Bajo'; }
      const pnode = document.getElementById('modal-prioridad');
      pnode.innerHTML = '';
      pnode.appendChild(badge);
      document.getElementById('modal-estado').textContent = d.estado || '';
  document.getElementById('modal-creado').textContent = d.creado_por || '';
      // show modal first so the map can calculate sizes correctly
      const modal = document.getElementById('report-modal');
      modal.classList.remove('hidden');
      modal.classList.add('flex');

      // close old map if exists
      if(window._modalMap){ try{ window._modalMap.remove(); }catch(e){} window._modalMap = null; }

      // create map after next paint
      requestAnimationFrame(()=>{
        const mapDiv = document.getElementById('modal-map');
        mapDiv.innerHTML = ''; // ensure empty
        // initialize map centered on a default until coordinates parsed
        window._modalMap = L.map('modal-map', {preferCanvas: true}).setView([4.716, -74.212], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:19}).addTo(window._modalMap);
        if(d.coordenadas && d.coordenadas.length>=2){
          const lat = parseFloat(d.coordenadas[1]);
          const lon = parseFloat(d.coordenadas[0]);
          if(!isNaN(lat) && !isNaN(lon)){
            window._modalMap.setView([lat, lon], 15);
            L.marker([lat, lon]).addTo(window._modalMap);
          }
        }
        // some layouts need an explicit invalidateSize to render correctly
        setTimeout(()=>{ try{ window._modalMap.invalidateSize(); }catch(e){} }, 80);
      });
      // image
      const imgDiv = document.getElementById('modal-image');
      imgDiv.innerHTML = '';
      if(d.imagen_url){
        const img = document.createElement('img');
        img.src = d.imagen_url;
        img.className = 'max-h-[320px] rounded-md border object-cover';
        img.style.width = '100%';
        imgDiv.appendChild(img);
      }
      // wire approve/reject buttons in modal to admin endpoints
      const approveBtn = document.getElementById('modal-approve');
      const rejectBtn = document.getElementById('modal-reject');
      if(approveBtn){ approveBtn.onclick = async ()=>{
        if(!confirm('Aprobar reporte #' + d.id + '?')) return;
        const res = await fetch(`/admin/api/reportes/${d.id}/validar/`, {method:'POST', headers: {'X-CSRFToken': getCookie('csrftoken')}});
        if(res.ok){ alert('Reporte aprobado'); modal.classList.remove('flex'); modal.classList.add('hidden'); fetchPending(); } else { alert('Error al aprobar'); }
      }}
      if(rejectBtn){ rejectBtn.onclick = async ()=>{
        if(!confirm('Rechazar/eliminar reporte #' + d.id + '?')) return;
        const res = await fetch(`/admin/api/reportes/${d.id}/rechazar/`, {method:'POST', headers: {'X-CSRFToken': getCookie('csrftoken')}});
        if(res.ok){ alert('Reporte rechazado'); modal.classList.remove('flex'); modal.classList.add('hidden'); fetchPending(); } else { alert('Error al rechazar'); }
      }}

      // wire delete button for validated reports
      const deleteBtn = document.getElementById('modal-delete');
      if(deleteBtn){
        if(d.estado && d.estado.toLowerCase() === 'validado'){
          deleteBtn.style.display = '';
        } else {
          deleteBtn.style.display = 'none';
        }
        deleteBtn.onclick = async ()=>{
          if(!confirm('Eliminar permanentemente el reporte #' + d.id + '? Esta acción es irreversible.')) return;
          const res = await fetch(`/admin/api/reportes/${d.id}/eliminar/`, {method:'POST', headers: {'X-CSRFToken': getCookie('csrftoken')}});
          if(res.ok){ alert('Reporte eliminado'); modal.classList.remove('flex'); modal.classList.add('hidden'); fetchPending(); } else { alert('Error al eliminar reporte'); }
        };
      }

      // close handler removes the map
      const closeModal = ()=>{ modal.classList.remove('flex'); modal.classList.add('hidden'); if(window._modalMap){ try{ window._modalMap.remove(); }catch(e){} window._modalMap = null; } };
      document.getElementById('modal-close').onclick = closeModal;
      modal.onclick = (ev)=>{ if(ev.target === modal){ closeModal(); } };
    }
  });
}

// integrate with existing attachActions flow
const originalAttach = window.attachActions;
window.attachActions = function(){
  if(typeof originalAttach === 'function'){
    try{ originalAttach(); }catch(e){ console.error('originalAttach', e); }
  }
  try{ attachViewActions(); }catch(e){ console.error('attachViewActions', e); }
};

// invoke to wire handlers for current DOM
try{ window.attachActions(); }catch(e){ console.error('attachActions invoke', e); }
</script>

</body>
</html>