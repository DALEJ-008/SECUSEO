<!DOCTYPE html>
{% load static %}
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Noto+Sans:wght@400;500;700;900&display=swap" rel="stylesheet">
    <title>Pagina Principal - SECUSEO</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>

    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        :root {
            --primary-color: #545dfa;
            --secondary-color: #f1f2ff;
            --background-color: #f1f2ff;
            --text-primary: #111827;
            --text-secondary: #6b7280;
        }

        #map {
            height: calc(100vh - 80px);
            width: 100%;
            position: relative;
            z-index: 0;
        }

        .leaflet-container {
            height: 100% !important;
            width: 100% !important;
        }

        .legend {
            line-height: 18px;
            color: #555;
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
        }

        .legend i {
            width: 18px;
            height: 18px;
            float: left;
            margin-right: 8px;
            opacity: 0.7;
        }

        .loading-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.9);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-background-color text-text-primary" style='font-family: "Poppins", "Noto Sans", sans-serif;'>
    <div class="relative flex h-screen w-full flex-col overflow-x-hidden">
        <div class="layout-container flex h-full grow flex-col">
            <!-- Header -->
            <header class="flex items-center justify-between whitespace-nowrap border-b border-solid border-gray-200 px-6 py-4">
                <div class="flex items-center gap-3 text-text-primary">
                    <img alt="SECUSEO Logo" class="h-12 w-auto" src="{% static 'HTML/Logo2.png' %}">
                </div>

                <div class="flex items-center gap-4">
                    <button class="relative rounded-full p-2 text-text-secondary hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-color">
                        <span class="material-symbols-outlined">notifications</span>
                        <span class="absolute top-2 right-2 flex h-2 w-2">
                            <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span>
                            <span class="relative inline-flex rounded-full h-2 w-2 bg-red-500"></span>
                        </span>
                    </button>
                    <button class="flex items-center gap-2">
                        <div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-10" style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuBNctnGaY6QTVJqT-mYE1ae6LBsiq_gxIYHaRsr3Tx-0BjFA91cKDlAqAwnzqxWl4rFYzt6aTfHi5YMoFZLCWuWmRViHCUQfn-cMSQlt3h5Te860SYz-cq_68ljldfktev7G730zE_V92uSaif-jpDuUwbkKTc3IQ49eNnqEnVJJMMQY64yb10rxHyNolI3krMzUiPSnbzEiioPSElPS-9RP6BlCqn0gzQxNNv4Z-WnPEl6YEn2EH7sEQif20wwKvA69UyaGWdckk0");'></div>
                        <span class="material-symbols-outlined text-text-secondary">expand_more</span>
                    </button>
                </div>
            </header>

            <div class="flex flex-1">
                <!-- Sidebar -->
                <aside class="w-96 flex-shrink-0 border-r border-gray-200 p-6" style="background-color: var(--background-color)">
                    <div class="flex flex-col gap-6">
                        <button id="report-new-btn" class="flex w-full items-center justify-center gap-2 rounded-md bg-primary-color py-3 text-black text-base font-bold shadow-sm hover:bg-opacity-90 transition-colors">
                            <span class="material-symbols-outlined">add_location_alt</span>
                            <span class="truncate">Reportar Nueva Zona</span>
                        </button>

                        <!-- Filtros -->
                        <div>
                            <h3 class="text-lg font-bold text-text-primary mb-4">Filtros</h3>
                            <div class="space-y-4">
                                <select id="risk-filter" class="form-select w-full rounded-md border-gray-300 shadow-sm focus:border-primary-color focus:ring-primary-color px-3 py-2">
                                    <option disabled selected>Tipo de Riesgo</option>
                                    <option value="">Todos</option>
                                    <option value="robo">Robo</option>
                                    <option value="asalto">Asalto</option>
                                    <option value="hurto">Hurto</option>
                                    <option value="vandalismo">Vandalismo</option>
                                    <option value="iluminacion">Poca iluminación</option>
                                    <option value="accidente">Accidente de Tránsito</option>
                                    <option value="violencia">Violencia</option>
                                    <option value="consumo_drogas">Consumo/venta de drogas</option>
                                    <option value="incendio">Incendio</option>
                                    <option value="amenaza">Amenaza</option>
                                    <option value="otro">Otro</option>
                                    <option value="robo_vehiculo">Robo de vehículos</option>
                                    <option value="acoso_callejero">Acoso callejero</option>
                                    <option value="prostitucion_ilegal">Prostitución ilegal</option>
                                    <option value="fraude_estafa">Fraudes y estafas</option>
                                </select>
                                <input class="form-input w-full rounded-md border-gray-300 shadow-sm focus:border-primary-color focus:ring-primary-color px-3 py-2" placeholder="Fecha" type="date">
                                <select class="form-select w-full rounded-md border-gray-300 shadow-sm focus:border-primary-color focus:ring-primary-color px-3 py-2">
                                    <option disabled selected>Estado</option>
                                    <option>Activo</option>
                                    <option>Resuelto</option>
                                    <option>En progreso</option>
                                </select>
                                <select id="neighborhood-filter" class="form-select w-full rounded-md border-gray-300 shadow-sm focus:border-primary-color focus:ring-primary-color px-3 py-2">
                                    <option disabled selected>Zona/Barrio</option>
                                    <option value="">Todos los barrios</option>
                                </select>
                            </div>
                        </div>

                        <!-- Reportes -->
                        <div>
                            <h3 class="text-lg font-bold text-text-primary mb-4">Reportes Recientes</h3>
                            <div id="recent-reports" class="space-y-4 max-h-96 overflow-y-auto">
                                <!-- Reportes recientes se cargarán vía JS desde /api/reportes/ -->
                            </div>
                        </div>
                    </div>
                </aside>

                <!-- Main Content -->
                <main class="flex-1 relative">

                    <!-- Loading overlay -->
                    <div id="loading" class="loading-overlay">
                        <div class="spinner"></div>
                        <span>Cargando delimitación de Funza...</span>
                    </div>

                    <!-- Barra de búsqueda -->
                    <div class="absolute top-6 left-6 w-full max-w-sm z-[1000]">
                        <label class="relative flex items-center">
                            <span class="material-symbols-outlined absolute left-4 text-text-secondary">search</span>
                            <input class="form-input w-full rounded-md border-gray-300 shadow-sm focus:border-primary-color focus:ring-primary-color pl-12 pr-4 py-3 bg-white" placeholder="Buscar en el mapa..." type="text">
                        </label>
                    </div>

                    <!-- Controles de zoom -->
                    <div class="absolute bottom-6 right-6 flex flex-col gap-2 z-[1000]">
                        <div class="flex flex-col rounded-md bg-white shadow-md">
                            <button id="zoom-in" class="flex size-12 items-center justify-center text-text-primary hover:bg-gray-100 rounded-t-md">
                                <span class="material-symbols-outlined">add</span>
                            </button>
                            <button id="zoom-out" class="flex size-12 items-center justify-center text-text-primary hover:bg-gray-100 rounded-b-md border-t border-gray-200">
                                <span class="material-symbols-outlined">remove</span>
                            </button>
                        </div>
                        <button id="locate-me" class="flex size-12 items-center justify-center rounded-md bg-white shadow-md text-text-primary hover:bg-gray-100">
                            <span class="material-symbols-outlined">my_location</span>
                        </button>
                    </div>

                    <!-- Mapa -->
                    <div id="map"></div>
                </main>
            </div>
        </div>
    </div>

    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>

    <script>
        // Inicializar el mapa centrado en Funza, Cundinamarca
        const map = L.map('map').setView([4.716, -74.212], 13);

        // Agregar capa base de OpenStreetMap
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            maxZoom: 19
        }).addTo(map);

    // Variables globales
    let geojsonLayer = null;
    let neighborhoodData = {};
    // Mapa de nombre de barrio -> capas (puede haber varios features con el mismo nombre)
    let neighborhoodLayers = {};

        // reportData will be computed from API responses (reportes reales)
        let reportData = {};

        // Helper: buscar reportData intentando coincidencia exacta y luego case-insensitive
        function findReportData(name) {
            if (!name) return null;
            const trimmed = name.trim();
            if (reportData[trimmed]) return reportData[trimmed];
            const lower = trimmed.toLowerCase();
            for (const key in reportData) {
                if (key.toLowerCase() === lower) return reportData[key];
            }
            return null;
        }

        // Función para calcular el color basado en reportes
        function getColor(neighborhoodName) {
            const data = findReportData(neighborhoodName);
            if (!data || data.total === 0) {
                return '#90EE90'; // Verde claro para zonas sin reportes
            }

            const riskScore = (data.highRisk * 3 + data.mediumRisk * 2 + data.lowRisk * 1) / data.total;

            if (riskScore >= 2.5) return '#8B0000'; // Rojo muy intenso
            if (riskScore >= 2.0) return '#DC143C'; // Rojo intenso
            if (riskScore >= 1.5) return '#FF4500'; // Naranja-rojo
            if (riskScore >= 1.0) return '#FF6347'; // Tomate
            return '#FFA07A'; // Salmón claro
        }

        // Función para estilo de cada feature
        function style(feature) {
            // El GeoJSON que tienes usa la propiedad "NOMBRE" para el nombre del barrio.
            // Añadimos varias comprobaciones para diferentes capitalizaciones/atributos.
            const neighborhoodName = feature.properties.BARRIO || feature.properties.NOMBRE || feature.properties.nombre || feature.properties.NAME || feature.properties.Name || feature.properties.name;
            return {
                fillColor: getColor(neighborhoodName),
                weight: 2,
                opacity: 1,
                color: 'white',
                dashArray: '3',
                fillOpacity: 0.7
            };
        }

        // Función para resaltar feature al hover
        function highlightFeature(e) {
            const layer = e.target;
            layer.setStyle({
                weight: 5,
                color: '#666',
                dashArray: '',
                fillOpacity: 0.8
            });
            layer.bringToFront();
        }

        // Función para resetear estilo
        function resetHighlight(e) {
            geojsonLayer.resetStyle(e.target);
        }

        // Función para zoom a feature al click
        function zoomToFeature(e) {
            map.fitBounds(e.target.getBounds());
        }

        // Función para manejar cada feature
        function onEachFeature(feature, layer) {
            const neighborhoodName = feature.properties.BARRIO || feature.properties.NOMBRE || feature.properties.nombre || feature.properties.NAME || feature.properties.Name || feature.properties.name;
            const data = findReportData(neighborhoodName);

            let popupContent = `<div class="p-3">
                <h3 class="font-bold text-lg mb-2">${neighborhoodName}</h3>`;

            if (data) {
                popupContent += `
                    <div class="space-y-1">
                        <p class="text-sm"><strong>Total reportes:</strong> ${data.total}</p>
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 bg-red-500 rounded-full"></div>
                            <span class="text-sm">Alto riesgo: ${data.highRisk}</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 bg-yellow-500 rounded-full"></div>
                            <span class="text-sm">Riesgo medio: ${data.mediumRisk}</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                            <span class="text-sm">Riesgo bajo: ${data.lowRisk}</span>
                        </div>
                    </div>`;
            } else {
                popupContent += `<p class="text-sm text-gray-600">Sin reportes registrados</p>`;
            }

            popupContent += `</div>`;

            layer.bindPopup(popupContent);

            // Guardar la capa por nombre de barrio para que el filtro pueda accederla
            if (neighborhoodName) {
                if (!neighborhoodLayers[neighborhoodName]) neighborhoodLayers[neighborhoodName] = [];
                neighborhoodLayers[neighborhoodName].push(layer);
            }

            layer.on({
                mouseover: highlightFeature,
                mouseout: resetHighlight,
                click: zoomToFeature
            });
        }

        // Cargar el archivo GeoJSON
        async function loadGeoJSON() {
            try {
                // Intentamos varias rutas (primero la ruta estática de Django, luego absoluta/relativa) para evitar problemas de path
                const candidateUrls = [
                    "{% static 'Recursos/Barrios_Funza.geojson' %}",
                    '/Recursos/Barrios_Funza.geojson',
                    '../Recursos/Barrios_Funza.geojson'
                ];

                let response = null;
                let usedUrl = null;

                for (const url of candidateUrls) {
                    try {
                        console.log('Intentando cargar GeoJSON desde', url);
                        response = await fetch(url, { cache: 'no-store' });
                        console.log('Respuesta:', url, response && response.status);
                        if (response && response.ok) {
                            usedUrl = url;
                            break;
                        }
                    } catch (e) {
                        console.warn('Error fetch a', url, e && e.message);
                    }
                }

                if (!response || !response.ok) {
                    const statuses = candidateUrls.map(u => `${u}`).join(', ');
                    throw new Error(`No se pudo cargar el GeoJSON desde las rutas probadas: ${candidateUrls.join(' | ')}`);
                }

                const geojsonData = await response.json();
                console.log('GeoJSON cargado desde', usedUrl, '- features:', geojsonData.features && geojsonData.features.length);

                // Crear la capa GeoJSON
                geojsonLayer = L.geoJSON(geojsonData, {
                    style: style,
                    onEachFeature: onEachFeature
                }).addTo(map);

                // Ajustar la vista al límite del GeoJSON
                map.fitBounds(geojsonLayer.getBounds());

                // Llenar el dropdown de barrios
                const neighborhoodFilter = document.getElementById('neighborhood-filter');
                const neighborhoods = [];

                geojsonData.features.forEach(feature => {
                    const name = feature.properties.BARRIO || feature.properties.NOMBRE || feature.properties.nombre || feature.properties.NAME || feature.properties.Name || feature.properties.name;
                    if (name && !neighborhoods.includes(name)) {
                        neighborhoods.push(name);
                    }
                });

                neighborhoods.sort().forEach(name => {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    neighborhoodFilter.appendChild(option);
                });

                // Añadir listener para el filtro de barrios: enfocar y resaltar el seleccionado
                neighborhoodFilter.addEventListener('change', function(e) {
                    const val = e.target.value;
                    if (!val) {
                        // Mostrar todos y resetear vista
                        geojsonLayer.eachLayer(l => geojsonLayer.resetStyle(l));
                        map.fitBounds(geojsonLayer.getBounds());
                        return;
                    }

                    const layers = neighborhoodLayers[val] || [];
                    // Resetear estilo de todos
                    geojsonLayer.eachLayer(l => geojsonLayer.resetStyle(l));

                    if (layers.length) {
                        // Resaltar las capas encontradas y ajustar la vista
                        layers.forEach(l => l.setStyle({ weight: 5, color: '#000', fillOpacity: 0.9 }));
                        const group = L.featureGroup(layers);
                        map.fitBounds(group.getBounds());
                    } else {
                        // Si no hay capas, no hacer nada
                        console.warn('No se encontraron capas para el barrio:', val);
                    }
                });

                // Ocultar loading
                document.getElementById('loading').style.display = 'none';

            } catch (error) {
                console.error('Error cargando el archivo GeoJSON:', error);
                // Mostrar mensaje corto en la UI y el error en la consola
                const loadingEl = document.getElementById('loading');
                loadingEl.innerHTML = `
                    <div class="text-red-600">
                        <span class="material-symbols-outlined">error</span>
                        <div>Error al cargar la delimitación de Funza</div>
                        <div class="text-sm mt-1">Verifique que el archivo GeoJSON esté en la ruta correcta</div>
                        <div class="text-xs mt-2">Detalle: ${String(error).slice(0,200)}</div>
                    </div>
                `;
            }
        }

        // Crear leyenda
        function createLegend() {
            const legend = L.control({position: 'bottomleft'});

            legend.onAdd = function (map) {
                const div = L.DomUtil.create('div', 'legend');
                const grades = [
                    { color: '#90EE90', label: 'Sin reportes' },
                    { color: '#FFA07A', label: 'Riesgo muy bajo' },
                    { color: '#FF6347', label: 'Riesgo bajo' },
                    { color: '#FF4500', label: 'Riesgo medio' },
                    { color: '#DC143C', label: 'Riesgo alto' },
                    { color: '#8B0000', label: 'Riesgo muy alto' }
                ];

                div.innerHTML = '<h4 style="margin: 0 0 10px 0; font-weight: bold;">Nivel de Riesgo</h4>';

                grades.forEach(grade => {
                    div.innerHTML +=
                        `<i style="background:${grade.color}"></i> ${grade.label}<br>`;
                });

                return div;
            };

            legend.addTo(map);
        }

        // Contenedor para marcadores de reportes (será poblado desde la API)
        let reportMarkersLayer = L.layerGroup().addTo(map);

        const riskColors = {
            'alto': '#b11',
            'muy_alto': '#660000',
            'medio': '#f39c12',
            'bajo': '#2ecc71'
        };

        async function loadReportMarkers() {
            try {
                const res = await fetch('/api/reportes/', { cache: 'no-store' });
                if (!res.ok) return;
                const data = await res.json();
                reportMarkersLayer.clearLayers();
                reportData = {}; // rebuild
                data.reportes.forEach(r => {
                    // If coordinates are present, create a marker
                    if (r.coordenadas && Array.isArray(r.coordenadas)) {
                        const [lng, lat] = r.coordenadas.length === 2 ? r.coordenadas : [r.coordenadas[0], r.coordenadas[1]];
                        const pri = (r.prioridad || '').toLowerCase();
                        const color = riskColors[pri] || '#888';
                        const marker = L.circleMarker([lat, lng], {
                            radius: 7,
                            fillColor: color,
                            color: '#000',
                            weight: 1,
                            opacity: 1,
                            fillOpacity: 0.9
                        }).addTo(reportMarkersLayer);
                        marker.bindPopup(`<div class="p-2"><h3 class="font-bold">Reporte</h3><p class="text-sm">${r.descripcion || ''}</p><p class="text-xs">Zona: ${r.zona || 'N/A'}</p></div>`);
                    }

                    // accumulate report stats by zona
                    const z = r.zona || 'Sin zona';
                    if (!reportData[z]) reportData[z] = { total: 0, highRisk: 0, mediumRisk: 0, lowRisk: 0 };
                    reportData[z].total += 1;
                    if (r.prioridad === 'muy_alto') reportData[z].highRisk += 2; // muy alto counts stronger
                    else if (r.prioridad === 'alto') reportData[z].highRisk += 1;
                    if (r.prioridad === 'medio') reportData[z].mediumRisk += 1;
                    if (r.prioridad === 'bajo') reportData[z].lowRisk += 1;
                });

                // After loading reports, re-style the geojson layer if already present
                if (geojsonLayer) {
                    geojsonLayer.setStyle(style);
                }
            } catch (err) {
                console.warn('No se pudieron cargar reportes:', err);
            }
        }

        // Render recent reports in the sidebar
        async function renderRecentReports() {
            try {
                const res = await fetch('/api/reportes/', { cache: 'no-store' });
                if (!res.ok) return;
                const data = await res.json();
                const container = document.getElementById('recent-reports');
                container.innerHTML = '';
                data.reportes.forEach(r => {
                    const div = document.createElement('div');
                    div.className = 'flex items-center gap-4 rounded-md border border-gray-200 p-3 hover:shadow-md transition-shadow cursor-pointer bg-white';
                    const color = r.prioridad === 'alto' ? 'bg-red-500' : (r.prioridad === 'medio' ? 'bg-yellow-500' : 'bg-green-500');
                    div.innerHTML = `
                        <div class="w-1.5 h-16 rounded-full ${color}"></div>
                        <div class="flex-1">
                            <p class="text-sm font-semibold ${r.prioridad === 'alto' ? 'text-red-600' : (r.prioridad === 'medio' ? 'text-yellow-600' : 'text-green-600')}">${r.prioridad ? ('Riesgo ' + r.prioridad.charAt(0).toUpperCase() + r.prioridad.slice(1)) : ''}</p>
                            <p class="font-bold text-text-primary">${r.descripcion ? r.descripcion.slice(0,60) : r.ubicacion}</p>
                            <p class="text-xs text-text-secondary">Zona: ${r.zona || 'Sin zona'}</p>
                        </div>
                        <span class="material-symbols-outlined text-text-secondary">chevron_right</span>
                    `;
                    container.appendChild(div);
                });
            } catch (e) {
                console.warn('No se pudieron renderizar reportes recientes', e);
            }
        }

        // Controles personalizados
        document.getElementById('zoom-in').addEventListener('click', function() {
            map.zoomIn();
        });

        document.getElementById('zoom-out').addEventListener('click', function() {
            map.zoomOut();
        });

        document.getElementById('locate-me').addEventListener('click', function() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    map.setView([lat, lng], 16);

                    L.marker([lat, lng])
                        .addTo(map)
                        .bindPopup('Tu ubicación actual')
                        .openPopup();
                }, function(error) {
                    alert('No se pudo obtener tu ubicación');
                });
            } else {
                alert('Geolocalización no soportada');
            }
        });

        // Inicializar todo cuando se carga la página
        document.addEventListener('DOMContentLoaded', function() {
            loadGeoJSON();
            createLegend();
            loadReportMarkers();
            renderRecentReports();

            const btn = document.getElementById('report-new-btn');
            if (btn) btn.addEventListener('click', () => { window.location.href = '/reporte/form/'; });
        });

        // Asegurar que el mapa se renderice correctamente
        setTimeout(function() {
            map.invalidateSize();
        }, 100);
    </script>
</body>
</html>