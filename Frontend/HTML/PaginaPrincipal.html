<!DOCTYPE html>
{% load static %}
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Noto+Sans:wght@400;500;700;900&display=swap" rel="stylesheet">
    <title>Pagina Principal - SECUSEO</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>

    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        :root {
            --primary-color: #545dfa;
            --secondary-color: #f1f2ff;
            --background-color: #f1f2ff;
            --text-primary: #111827;
            --text-secondary: #6b7280;
        }

        #map {
            height: calc(100vh - 80px);
            width: 100%;
            position: relative;
            z-index: 0;
        }

        .leaflet-container {
            height: 100% !important;
            width: 100% !important;
        }

        .legend {
            line-height: 18px;
            color: #555;
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
        }

        .legend i {
            width: 18px;
            height: 18px;
            float: left;
            margin-right: 8px;
            opacity: 0.7;
        }

        .loading-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.9);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-background-color text-text-primary" style='font-family: "Poppins", "Noto Sans", sans-serif;'>
    <div class="relative flex h-screen w-full flex-col overflow-x-hidden">
        <div class="layout-container flex h-full grow flex-col">
            <!-- Header -->
            <header class="flex items-center justify-between whitespace-nowrap border-b border-solid border-gray-200 px-6 py-4">
                <div class="flex items-center gap-3 text-text-primary">
                    <img alt="SECUSEO Logo" class="h-12 w-auto" src="{% static 'HTML/Logo2.png' %}">
                </div>

                                <div class="flex items-center gap-4">
                                        <!-- Notifications dropdown -->
                                        <div class="relative">
                                            <button id="btn-notifications" class="relative rounded-full p-2 text-text-secondary hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-color">
                                                <span class="material-symbols-outlined">notifications</span>
                                                <span id="notif-badge" class="absolute -top-1 -right-1 hidden inline-flex items-center justify-center rounded-full bg-red-500 text-white text-xs w-5 h-5">0</span>
                                            </button>
                                            <div id="dropdown-notifications" class="hidden absolute right-0 mt-2 w-80 bg-white border border-gray-200 rounded-md shadow-lg z-50">
                                                <div class="p-3 text-sm font-semibold">Notificaciones</div>
                                                <div id="notif-list" class="max-h-56 overflow-auto divide-y"></div>
                                                <div class="p-2 text-center text-xs text-gray-500">No disponibles</div>
                                            </div>
                                        </div>

                                        <!-- Profile dropdown -->
                                        <div class="relative">
                                            <button id="btn-profile" class="flex items-center gap-2">
                                                <div id="profile-photo" class="bg-center bg-no-repeat aspect-square bg-cover rounded-full w-9 h-9" style="background-image: url('{% static "HTML/Logo3.png" %}');"></div>
                                                <span id="profile-arrow" class="material-symbols-outlined text-text-secondary">expand_more</span>
                                            </button>
                                            <div id="dropdown-profile" class="hidden absolute right-0 mt-2 w-56 bg-white border border-gray-200 rounded-md shadow-lg z-50">
                                                <div class="p-3">
                                                    <div id="profile-username" class="font-medium">Usuario</div>
                                                    <div id="profile-email" class="text-xs text-gray-500">email@example.com</div>
                                                </div>
                                                <div class="divide-y">
                                                    <div class="p-2">
                                                        <a href="/" class="block p-2 rounded hover:bg-gray-50">Página principal</a>
                                                        <button id="btn-view-profile" class="w-full text-left p-2 rounded hover:bg-gray-50">Ver perfil</button>
                                                    </div>
                                                    <div class="p-2">
                                                        <a id="btn-admin-panel" href="/admin-panel/" class="block p-2 rounded hover:bg-gray-50 hidden">Panel de Administración</a>
                                                        <button id="btn-logout" class="block w-full text-left p-2 rounded hover:bg-gray-50">Cerrar sesión</button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                </div>
            </header>

            <div class="flex flex-1">
                <!-- Sidebar -->
                <aside class="w-96 flex-shrink-0 border-r border-gray-200 p-6 bg-[var(--background-color)]">
                    <div class="flex flex-col gap-6">
                        <button id="report-new-btn" class="flex w-full items-center justify-center gap-2 rounded-md bg-primary-color py-3 text-black text-base font-bold shadow-sm hover:bg-opacity-90 transition-colors">
                            <span class="material-symbols-outlined">add_location_alt</span>
                            <span class="truncate">Reportar Nueva Zona</span>
                        </button>

                        <!-- Filtros -->
                        <div>
                            <h3 class="text-lg font-bold text-text-primary mb-4">Filtros</h3>
                            <div class="space-y-4">
                                <select id="risk-filter" class="form-select w-full rounded-md border-gray-300 shadow-sm focus:border-primary-color focus:ring-primary-color px-3 py-2">
                                    <option disabled selected>Tipo de Riesgo</option>
                                    <option value="">Todos</option>
                                    <option value="robo">Robo</option>
                                    <option value="asalto">Asalto</option>
                                    <option value="hurto">Hurto</option>
                                    <option value="vandalismo">Vandalismo</option>
                                    <option value="iluminacion">Poca iluminación</option>
                                    <option value="accidente">Accidente de Tránsito</option>
                                    <option value="violencia">Violencia</option>
                                    <option value="consumo_drogas">Consumo/venta de drogas</option>
                                    <option value="incendio">Incendio</option>
                                    <option value="amenaza">Amenaza</option>
                                    <option value="otro">Otro</option>
                                    <option value="robo_vehiculo">Robo de vehículos</option>
                                    <option value="acoso_callejero">Acoso callejero</option>
                                    <option value="prostitucion_ilegal">Prostitución ilegal</option>
                                    <option value="fraude_estafa">Fraudes y estafas</option>
                                </select>
                                <input class="form-input w-full rounded-md border-gray-300 shadow-sm focus:border-primary-color focus:ring-primary-color px-3 py-2" placeholder="Fecha" type="date">
                                <select class="form-select w-full rounded-md border-gray-300 shadow-sm focus:border-primary-color focus:ring-primary-color px-3 py-2">
                                    <option disabled selected>Estado</option>
                                    <option>Activo</option>
                                    <option>Resuelto</option>
                                    <option>En progreso</option>
                                </select>
                                <select id="neighborhood-filter" class="form-select w-full rounded-md border-gray-300 shadow-sm focus:border-primary-color focus:ring-primary-color px-3 py-2">
                                    <option disabled selected>Zona/Barrio</option>
                                    <option value="">Todos los barrios</option>
                                </select>
                            </div>
                        </div>

                        <!-- Reportes -->
                        <div>
                            <h3 class="text-lg font-bold text-text-primary mb-4">Reportes Recientes</h3>
                            <div id="recent-reports" class="space-y-4 max-h-96 overflow-y-auto">
                                <!-- Reportes recientes se cargarán vía JS desde /api/reportes/ -->
                            </div>
                        </div>
                    </div>
                </aside>

                <!-- Main Content -->
                <main class="flex-1 relative">

                    <!-- Loading overlay -->
                    <div id="loading" class="loading-overlay">
                        <div class="spinner"></div>
                        <span>Cargando delimitación de Funza...</span>
                    </div>

                    <!-- Barra de búsqueda -->
                    <div class="absolute top-6 left-6 w-full max-w-sm z-[1000]">
                        <label class="relative flex items-center">
                            <span class="material-symbols-outlined absolute left-4 text-text-secondary">search</span>
                            <input class="form-input w-full rounded-md border-gray-300 shadow-sm focus:border-primary-color focus:ring-primary-color pl-12 pr-4 py-3 bg-white" placeholder="Buscar en el mapa..." type="text">
                        </label>
                    </div>

                    <!-- Controles de zoom -->
                    <div class="absolute bottom-6 right-6 flex flex-col gap-2 z-[1000]">
                        <div class="flex flex-col rounded-md bg-white shadow-md">
                            <button id="zoom-in" class="flex size-12 items-center justify-center text-text-primary hover:bg-gray-100 rounded-t-md">
                                <span class="material-symbols-outlined">add</span>
                            </button>
                            <button id="zoom-out" class="flex size-12 items-center justify-center text-text-primary hover:bg-gray-100 rounded-b-md border-t border-gray-200">
                                <span class="material-symbols-outlined">remove</span>
                            </button>
                        </div>
                        <button id="locate-me" class="flex size-12 items-center justify-center rounded-md bg-white shadow-md text-text-primary hover:bg-gray-100">
                            <span class="material-symbols-outlined">my_location</span>
                        </button>
                    </div>

                    <!-- Mapa -->
                    <div id="map"></div>
                </main>
            </div>
        </div>
    </div>

    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>

    <script>
        // Inicializar el mapa centrado en Funza, Cundinamarca
        const map = L.map('map').setView([4.716, -74.212], 13);

        // Agregar capa base de OpenStreetMap
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            maxZoom: 19
        }).addTo(map);

    // Variables globales
    let geojsonLayer = null;
    let neighborhoodData = {};
    let geojsonDataGlobal = null;
    // Mapa de nombre de barrio -> capas (puede haber varios features con el mismo nombre)
    let neighborhoodLayers = {};

        // reportData will be computed from API responses (reportes reales)
        // structure: { zonaName: { total: n, score: x, reports: [r,...] } }
        let reportData = {};

        // CSRF helper (for Django) - used by notification/comment POSTs
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return null;
        }

        // Normalize neighborhood names to a canonical key for lookups
        function normalizeName(name){
            if(name === undefined || name === null) return '';
            try{ return name.toString().trim().toLowerCase(); }catch(e){ return String(name).trim().toLowerCase(); }
        }

        // Helper: buscar reportData usando nombre normalizado
        function findReportData(name) {
            if (!name) return null;
            const key = normalizeName(name);
            return reportData[key] || null;
        }

        // Pretty-print a raw tipo/prioridad value into a human-friendly label
        function prettyType(raw) {
            if (!raw && raw !== 0) return '';
            const s = String(raw).toLowerCase().trim();
            const MAP = {
                'robo': 'Robo',
                'asalto': 'Asalto',
                'hurto': 'Hurto',
                'vandalismo': 'Vandalismo',
                'iluminacion': 'Poca iluminación',
                'accidente': 'Accidente de Tránsito',
                'violencia': 'Violencia',
                'consumo_drogas': 'Consumo/venta de drogas',
                'consumo/venta de drogas': 'Consumo/venta de drogas',
                'incendio': 'Incendio',
                'amenaza': 'Amenaza',
                'otro': 'Otro',
                'robo_vehiculo': 'Robo de vehículos',
                'acoso_callejero': 'Acoso callejero',
                'prostitucion_ilegal': 'Prostitución ilegal',
                'fraude_estafa': 'Fraudes y estafas'
            };
            if (MAP[s]) return MAP[s];
            // keyword matches
            if (s.includes('ilumin') || s.includes('luz')) return 'Poca iluminación';
            if (s.includes('robo')) return 'Robo';
            if (s.includes('asalto')) return 'Asalto';
            if (s.includes('hurto')) return 'Hurto';
            if (s.includes('violencia')) return 'Violencia';
            if (s.includes('vandal')) return 'Vandalismo';
            if (s.includes('accident')) return 'Accidente de Tránsito';
            if (s.includes('drog')) return 'Consumo/venta de drogas';
            if (s.includes('incend')) return 'Incendio';
            if (s.includes('amenaz')) return 'Amenaza';
            // fallback: replace underscores and capitalize
            const cleaned = s.replace(/_/g, ' ');
            return cleaned.charAt(0).toUpperCase() + cleaned.slice(1);
        }

        // Función para calcular el color basado en reportes
        // Map a normalized ratio (0..1) to a color between green and red.
        function colorForRatio(ratio){
            // clamp
            const r = Math.max(0, Math.min(1, ratio));
            // hue: 120 (green) -> 0 (red)
            const hue = (1 - r) * 120;
            // use HSL for smooth gradient
            return `hsl(${hue}, 75%, ${r > 0.6 ? '45%' : r > 0.3 ? '55%' : '70%'})`;
        }

        function getColor(neighborhoodName) {
            const data = findReportData(neighborhoodName);
            if (!data || !data.reports || data.reports.length === 0) {
                return '#90EE90'; // Verde claro para zonas sin reportes
            }
            // compute normalized ratio relative to combined metric precomputed in loadReportMarkers
            const maxCombined = reportData.__maxScore__ || 0;
            const combined = data.__combined__ || ((data.score || 0) * Math.log(1 + (data.total || 0)));
            if (maxCombined <= 0) {
                // fallback: single report -> light orange
                return colorForRatio(0.18);
            }
            let ratio = combined / maxCombined;
            // Guarantee that any zone with at least one report is not pure green.
            if ((data.total || 0) > 0) {
                const minForAny = Math.min(0.12 + Math.log(1 + data.total) * 0.03, 0.25);
                ratio = Math.max(ratio, minForAny);
            }
            // cap the ratio to avoid tiny counts becoming extremely red
            ratio = Math.min(ratio, 0.98);
            return colorForRatio(ratio);
        }

        // Función para estilo de cada feature
        function style(feature) {
            // El GeoJSON que tienes usa la propiedad "NOMBRE" para el nombre del barrio.
            // Añadimos varias comprobaciones para diferentes capitalizaciones/atributos.
            const neighborhoodName = feature.properties.BARRIO || feature.properties.NOMBRE || feature.properties.nombre || feature.properties.NAME || feature.properties.Name || feature.properties.name;
            return {
                fillColor: getColor(neighborhoodName),
                weight: 2,
                opacity: 1,
                color: 'white',
                dashArray: '3',
                fillOpacity: 0.7
            };
        }

        // Map raw prioridad/tipo to a risk level string (Alto/Medio/Bajo)
        function mapPriorityToLevel(p){
            if(!p) return 'Bajo';
            const s = String(p).toLowerCase();
            if(s.includes('alto') || s.includes('3') || s.includes('3.0')) return 'Alto';
            if(s.includes('medio') || s.includes('2') || s.includes('2.0')) return 'Medio';
            if(s.includes('asalto') || s.includes('violencia') || s.includes('robo')) return 'Alto';
            // Poca iluminación se considera nivel Bajo en la vista principal
            if(s.includes('ilumin') || s.includes('iluminacion')) return 'Bajo';
            if(s.includes('hurto') || s.includes('vandal')) return 'Medio';
            return 'Bajo';
        }

        // Función para resaltar feature al hover
        function highlightFeature(e) {
            const layer = e.target;
            layer.setStyle({
                weight: 5,
                color: '#666',
                dashArray: '',
                fillOpacity: 0.8
            });
            layer.bringToFront();
        }

        // Función para resetear estilo
        function resetHighlight(e) {
            geojsonLayer.resetStyle(e.target);
        }

        // Función para zoom a feature al click
        function zoomToFeature(e) {
            map.fitBounds(e.target.getBounds());
        }

        // Función para manejar cada feature (muestra listado de reportes de la zona en el popup)
        function onEachFeature(feature, layer) {
            const neighborhoodName = feature.properties.BARRIO || feature.properties.NOMBRE || feature.properties.nombre || feature.properties.NAME || feature.properties.Name || feature.properties.name;
            const data = findReportData(neighborhoodName);

            let popupContent = `<div class="p-3">
                <h3 class="font-bold text-lg mb-2">${neighborhoodName || 'Sin nombre'}</h3>`;

            if (data && data.reports && data.reports.length) {
                popupContent += `<p class="text-sm"><strong>Total reportes:</strong> ${data.total}</p>`;
                popupContent += `<div class="mt-2 space-y-2">`;
                // list each report briefly
                data.reports.slice(0,10).forEach(r => {
                    const desc = (r.descripcion || r.ubicacion || '').toString().slice(0,120);
                    const priLabel = prettyType(r.tipo || r.prioridad || '');
                    popupContent += `<div class="p-2 rounded bg-white border">`;
                    popupContent += `<div class="flex items-center justify-between"><div class="text-sm font-semibold">${priLabel || 'Tipo desconocido'}</div><div class="text-xs text-gray-500">${r.fecha_creacion ? new Date(r.fecha_creacion).toLocaleString() : ''}</div></div>`;
                    popupContent += `<div class="text-sm text-gray-700 mt-1">${desc}</div>`;
                    popupContent += `</div>`;
                });
                if (data.reports.length > 10) popupContent += `<div class="text-xs text-gray-500 mt-2">Mostrando 10 de ${data.reports.length} reportes</div>`;
                popupContent += `</div>`;
            } else {
                popupContent += `<p class="text-sm text-gray-600">Sin reportes registrados</p>`;
            }

            popupContent += `</div>`;

            layer.bindPopup(popupContent, {maxWidth: 400});

            // Guardar la capa por nombre de barrio normalizado para que el filtro pueda accederla
            if (neighborhoodName) {
                const key = normalizeName(neighborhoodName);
                if (!neighborhoodLayers[key]) neighborhoodLayers[key] = [];
                neighborhoodLayers[key].push(layer);
            }

            layer.on({
                mouseover: highlightFeature,
                mouseout: resetHighlight,
                click: zoomToFeature
            });
        }

        // Cargar el archivo GeoJSON
        async function loadGeoJSON() {
            try {
                // Intentamos varias rutas (primero la ruta estática de Django, luego absoluta/relativa) para evitar problemas de path
                const candidateUrls = [
                    "{% static 'Recursos/Barrios_Funza.geojson' %}",
                    '/Recursos/Barrios_Funza.geojson',
                    '../Recursos/Barrios_Funza.geojson'
                ];

                let response = null;
                let usedUrl = null;

                for (const url of candidateUrls) {
                    try {
                        console.log('Intentando cargar GeoJSON desde', url);
                        response = await fetch(url, { cache: 'no-store' });
                        console.log('Respuesta:', url, response && response.status);
                        if (response && response.ok) {
                            usedUrl = url;
                            break;
                        }
                    } catch (e) {
                        console.warn('Error fetch a', url, e && e.message);
                    }
                }

                if (!response || !response.ok) {
                    const statuses = candidateUrls.map(u => `${u}`).join(', ');
                    throw new Error(`No se pudo cargar el GeoJSON desde las rutas probadas: ${candidateUrls.join(' | ')}`);
                }

                const geojsonData = await response.json();
                // keep a global copy for client-side point-in-polygon lookups
                geojsonDataGlobal = geojsonData;
                console.log('GeoJSON cargado desde', usedUrl, '- features:', geojsonData.features && geojsonData.features.length);

                // Crear la capa GeoJSON
                geojsonLayer = L.geoJSON(geojsonData, {
                    style: style,
                    onEachFeature: onEachFeature
                }).addTo(map);

                // Ajustar la vista al límite del GeoJSON
                map.fitBounds(geojsonLayer.getBounds());

                // Llenar el dropdown de barrios
                const neighborhoodFilter = document.getElementById('neighborhood-filter');
                const neighborhoods = [];

                geojsonData.features.forEach(feature => {
                    const name = feature.properties.BARRIO || feature.properties.NOMBRE || feature.properties.nombre || feature.properties.NAME || feature.properties.Name || feature.properties.name;
                    if (name && !neighborhoods.includes(name)) {
                        neighborhoods.push(name);
                    }
                });

                neighborhoods.sort().forEach(name => {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    neighborhoodFilter.appendChild(option);
                });

                // Añadir listener para el filtro de barrios: enfocar y resaltar el seleccionado
                neighborhoodFilter.addEventListener('change', function(e) {
                    const val = e.target.value;
                    if (!val) {
                        // Mostrar todos y resetear vista
                        geojsonLayer.eachLayer(l => geojsonLayer.resetStyle(l));
                        map.fitBounds(geojsonLayer.getBounds());
                        return;
                    }

                    const layers = neighborhoodLayers[normalizeName(val)] || [];
                    // Resetear estilo de todos
                    geojsonLayer.eachLayer(l => geojsonLayer.resetStyle(l));

                    if (layers.length) {
                        // Resaltar las capas encontradas y ajustar la vista
                        layers.forEach(l => l.setStyle({ weight: 5, color: '#000', fillOpacity: 0.9 }));
                        const group = L.featureGroup(layers);
                        map.fitBounds(group.getBounds());
                    } else {
                        // Si no hay capas, no hacer nada
                        console.warn('No se encontraron capas para el barrio:', val);
                    }
                });

                // Ocultar loading
                document.getElementById('loading').style.display = 'none';

            } catch (error) {
                console.error('Error cargando el archivo GeoJSON:', error);
                // Mostrar mensaje corto en la UI y el error en la consola
                const loadingEl = document.getElementById('loading');
                loadingEl.innerHTML = `
                    <div class="text-red-600">
                        <span class="material-symbols-outlined">error</span>
                        <div>Error al cargar la delimitación de Funza</div>
                        <div class="text-sm mt-1">Verifique que el archivo GeoJSON esté en la ruta correcta</div>
                        <div class="text-xs mt-2">Detalle: ${String(error).slice(0,200)}</div>
                    </div>
                `;
            }
        }

        // Client-side point-in-polygon helper for GeoJSON Polygons/MultiPolygons
        function _ringContains(x, y, ring) {
            let inside = false;
            let j = ring.length - 1;
            for (let i = 0; i < ring.length; i++) {
                const xi = ring[i][0], yi = ring[i][1];
                const xj = ring[j][0], yj = ring[j][1];
                const intersect = ((yi > y) !== (yj > y)) && (x < (xj - xi) * (y - yi) / ((yj - yi) || 1e-12) + xi);
                if (intersect) inside = !inside;
                j = i;
            }
            return inside;
        }

        function pointInGeoJSON(lon, lat) {
            if (!geojsonDataGlobal || !geojsonDataGlobal.features) return null;
            for (let fi = 0; fi < geojsonDataGlobal.features.length; fi++) {
                const f = geojsonDataGlobal.features[fi];
                if (!f || !f.geometry) continue;
                const g = f.geometry;
                if (g.type === 'Polygon') {
                    if (_ringContains(lon, lat, g.coordinates[0])) return f;
                } else if (g.type === 'MultiPolygon') {
                    for (let pi = 0; pi < g.coordinates.length; pi++) {
                        if (_ringContains(lon, lat, g.coordinates[pi][0])) return f;
                    }
                }
            }
            return null;
        }

        // Crear leyenda
        function createLegend() {
            const legend = L.control({position: 'bottomleft'});

            legend.onAdd = function (map) {
                const div = L.DomUtil.create('div', 'legend');
                const grades = [
                    { color: '#90EE90', label: 'Sin reportes' },
                    { color: '#FFA07A', label: 'Riesgo muy bajo' },
                    { color: '#FF6347', label: 'Riesgo bajo' },
                    { color: '#FF4500', label: 'Riesgo medio' },
                    { color: '#DC143C', label: 'Riesgo alto' },
                    { color: '#8B0000', label: 'Riesgo muy alto' }
                ];

                div.innerHTML = '<h4 style="margin: 0 0 10px 0; font-weight: bold;">Nivel de Riesgo</h4>';

                grades.forEach(grade => {
                    div.innerHTML +=
                        `<i style="background:${grade.color}"></i> ${grade.label}<br>`;
                });

                return div;
            };

            legend.addTo(map);
        }

        // Contenedor para marcadores de reportes (será poblado desde la API)
        let reportMarkersLayer = L.layerGroup().addTo(map);

        const riskColors = {
            'alto': '#b11',
            'muy_alto': '#660000',
            'medio': '#f39c12',
            'bajo': '#2ecc71'
        };

        async function loadReportMarkers() {
            try {
                const res = await fetch('/api/reportes/', { cache: 'no-store' });
                if (!res.ok) return;
                const data = await res.json();
                reportMarkersLayer.clearLayers();
                // rebuild reportData with per-zone arrays and a score
                reportData = {};
                data.reportes.forEach(r => {
                    // if backend didn't assign a zona but we have coordinates and GeoJSON is loaded,
                    // try to infer the zona on the client side so colors update immediately
                    if ((!r.zona || r.zona === null || r.zona === 'Sin zona') && r.coordenadas && Array.isArray(r.coordenadas) && geojsonDataGlobal) {
                        try {
                            const lng = parseFloat(r.coordenadas[0]);
                            const lat = parseFloat(r.coordenadas[1]);
                            const f = pointInGeoJSON(lng, lat);
                            if (f && f.properties) {
                                const name = f.properties.BARRIO || f.properties.NOMBRE || f.properties.nombre || f.properties.NAME || f.properties.Name || f.properties.name;
                                if (name) r.zona = name;
                            }
                        } catch (e) {
                            // ignore
                        }
                    }
                    // create markers for reports that have coordinates (optional)
                    if (r.coordenadas && Array.isArray(r.coordenadas)) {
                        const [lng, lat] = r.coordenadas.length === 2 ? r.coordenadas : [r.coordenadas[0], r.coordenadas[1]];
                        const pri = prettyType(r.tipo || r.prioridad || '');
                        const color = (pri.includes('alto') || pri.includes('muy')) ? '#b11' : (pri.includes('medio') ? '#f39c12' : '#2ecc71');
                        const marker = L.circleMarker([lat, lng], {
                            radius: 6,
                            fillColor: color,
                            color: '#000',
                            weight: 1,
                            opacity: 1,
                            fillOpacity: 0.9
                        }).addTo(reportMarkersLayer);
                        const markerTitle = prettyType(r.tipo || r.prioridad || '') || 'Reporte';
                        marker.bindPopup(`<div class="p-2"><h3 class="font-bold">${markerTitle}</h3><p class="text-sm">${r.descripcion || ''}</p><p class="text-xs">Zona: ${r.zona || 'N/A'}</p></div>`);
                    }

                    const z = r.zona || 'Sin zona';
                    const zKey = normalizeName(z);
                    if (!reportData[zKey]) reportData[zKey] = { total: 0, score: 0, reports: [], __displayName: z };
                    reportData[zKey].total += 1;
                    // determine weight by priority/type
                    // configurable weight map for concrete risk types (more meaningful than generic priority)
                    const TYPE_WEIGHTS = {
                        'robo': 3.0,
                        'asalto': 3.5,
                        'violencia': 3.5,
                        'hurto': 1.8,
                        'vandalismo': 1.5,
                        'iluminacion': 0.8,
                        'accidente': 1.2,
                        'consumo_drogas': 2.2,
                        'consumo/venta de drogas': 2.2,
                        'incendio': 3.5,
                        'amenaza': 2.5,
                        'robo_vehiculo': 3.0,
                        'acoso_callejero': 2.0,
                        'prostitucion_ilegal': 2.0,
                        'fraude_estafa': 1.5,
                        'violencia': 3.5,
                        'otro': 1.0
                    };
                    const pr = (r.prioridad || r.tipo || '').toString().toLowerCase().trim();
                    let w = 1;
                    if (pr) {
                        // exact match
                        if (TYPE_WEIGHTS[pr]) w = TYPE_WEIGHTS[pr];
                        else {
                            // try to match keywords
                            if (pr.includes('robo')) w = TYPE_WEIGHTS['robo'];
                            else if (pr.includes('asalto')) w = TYPE_WEIGHTS['asalto'];
                            else if (pr.includes('violencia')) w = TYPE_WEIGHTS['violencia'];
                            else if (pr.includes('hurto')) w = TYPE_WEIGHTS['hurto'];
                            else if (pr.includes('vandal')) w = TYPE_WEIGHTS['vandalismo'];
                            else if (pr.includes('ilumin') || pr.includes('luz')) w = TYPE_WEIGHTS['iluminacion'];
                            else if (pr.includes('accident')) w = TYPE_WEIGHTS['accidente'];
                            else if (pr.includes('drog')) w = TYPE_WEIGHTS['consumo_drogas'];
                            else if (pr.includes('incend')) w = TYPE_WEIGHTS['incendio'];
                            else if (pr.includes('amenaz')) w = TYPE_WEIGHTS['amenaza'];
                            else if (pr.includes('vehicul') && pr.includes('robo')) w = TYPE_WEIGHTS['robo_vehiculo'];
                            else if (pr.includes('acoso')) w = TYPE_WEIGHTS['acoso_callejero'];
                            else if (pr.includes('prostitucion')) w = TYPE_WEIGHTS['prostitucion_ilegal'];
                            else if (pr.includes('fraud') || pr.includes('estaf')) w = TYPE_WEIGHTS['fraude_estafa'];
                            else {
                                // fallback to priority keywords
                                if (pr.includes('muy') && pr.includes('alto')) w = 3;
                                else if (pr.includes('alto')) w = 2;
                                else if (pr.includes('medio')) w = 1.2;
                                else if (pr.includes('bajo')) w = 0.6;
                                else w = 1;
                            }
                        }
                    }
                    reportData[zKey].score += w;
                    // push original report object for popup listing
                    reportData[zKey].reports.push(r);
                });

                // compute a combined metric (score * f(total)) so both severity and count influence color
                // use f(total) = log(1 + total) to give diminishing returns for high counts
                let maxCombined = 0;
                Object.keys(reportData).forEach(k => {
                    const entry = reportData[k];
                    const total = entry.total || 0;
                    const combined = (entry.score || 0) * Math.log(1 + total);
                    entry.__combined__ = combined;
                    if (combined > maxCombined) maxCombined = combined;
                });
                reportData.__maxScore__ = maxCombined;

                // After loading reports, re-style the geojson layer if already present
                if (geojsonLayer) {
                    geojsonLayer.setStyle(style);
                    // update popups by re-binding onEachFeature may be needed; easiest is to recreate the layer
                    geojsonLayer.eachLayer(function(layer){
                        // force popup content update by calling onEachFeature logic via feature
                        const feat = layer.feature;
                        // rebind popup using existing onEachFeature function
                        if (feat) {
                            const neighborhoodName = feat.properties.BARRIO || feat.properties.NOMBRE || feat.properties.nombre || feat.properties.NAME || feat.properties.Name || feat.properties.name;
                            const dataZone = findReportData(neighborhoodName);
                            let popupContent = `<div class="p-3"><h3 class="font-bold text-lg mb-2">${neighborhoodName || 'Sin nombre'}</h3>`;
                            if (dataZone && dataZone.reports && dataZone.reports.length) {
                                popupContent += `<p class="text-sm"><strong>Total reportes:</strong> ${dataZone.total}</p><div class="mt-2 space-y-2">`;
                                dataZone.reports.slice(0,10).forEach(r => {
                                    const desc = (r.descripcion || r.ubicacion || '').toString().slice(0,120);
                                    const pri = prettyType(r.tipo || r.prioridad || '');
                                    popupContent += `<div class="p-2 rounded bg-white border"><div class="flex items-center justify-between"><div class="text-sm font-semibold">${pri || 'Tipo desconocido'}</div><div class="text-xs text-gray-500">${r.fecha_creacion ? new Date(r.fecha_creacion).toLocaleString() : ''}</div></div>`;
                                    popupContent += `<div class="text-sm text-gray-700 mt-1">${desc}</div></div>`;
                                });
                                if (dataZone.reports.length > 10) popupContent += `<div class="text-xs text-gray-500 mt-2">Mostrando 10 de ${dataZone.reports.length} reportes</div>`;
                                popupContent += `</div>`;
                            } else {
                                popupContent += `<p class="text-sm text-gray-600">Sin reportes registrados</p>`;
                            }
                            popupContent += `</div>`;
                            layer.bindPopup(popupContent, {maxWidth:400});
                        }
                    });
                }
            } catch (err) {
                console.warn('No se pudieron cargar reportes:', err);
            }
        }

        // Render recent reports in the sidebar
        async function renderRecentReports() {
            try {
                const res = await fetch('/api/reportes/', { cache: 'no-store' });
                if (!res.ok) return;
                const data = await res.json();
                const container = document.getElementById('recent-reports');
                container.innerHTML = '';
                data.reportes.forEach(r => {
                    // Ensure cards reflect the same zona as the map: if backend didn't provide zona,
                    // and we have coordinates and the geojson is loaded, infer client-side.
                    if ((!r.zona || r.zona === null || r.zona === 'Sin zona') && r.coordenadas && Array.isArray(r.coordenadas) && geojsonDataGlobal) {
                        try {
                            const lng = parseFloat(r.coordenadas[0]);
                            const lat = parseFloat(r.coordenadas[1]);
                            const f = pointInGeoJSON(lng, lat);
                            if (f && f.properties) {
                                const name = f.properties.BARRIO || f.properties.NOMBRE || f.properties.nombre || f.properties.NAME || f.properties.Name || f.properties.name;
                                if (name) r.zona = name;
                            }
                        } catch (e) {
                            // ignore
                        }
                    }
                    const div = document.createElement('div');
                    div.className = 'flex items-center gap-4 rounded-md border border-gray-200 p-3 hover:shadow-md transition-shadow cursor-pointer bg-white';
                    const level = mapPriorityToLevel(r.prioridad || r.tipo || '');
                        const color = level === 'Alto' ? 'bg-red-500' : (level === 'Medio' ? 'bg-yellow-500' : 'bg-green-500');
                        const textColor = level === 'Alto' ? 'text-red-600' : (level === 'Medio' ? 'text-yellow-600' : 'text-green-600');
                        const typeLabel = prettyType(r.tipo || r.prioridad || '');
                        div.innerHTML = `
                            <div class="w-1.5 h-16 rounded-full ${color}"></div>
                            <div class="flex-1">
                                <p class="text-sm font-semibold ${textColor}">${typeLabel ? typeLabel : 'Riesgo ' + level}</p>
                                <p class="font-bold text-text-primary">${r.descripcion ? r.descripcion.slice(0,60) : r.ubicacion}</p>
                                <p class="text-xs text-text-secondary">Zona: ${r.zona || 'Sin zona'}</p>
                            </div>
                                                <button class="open-detail" data-id="${r.id}" aria-label="Ver detalle">
                                                        <span class="material-symbols-outlined text-text-secondary">chevron_right</span>
                                                </button>
                    `;
                    container.appendChild(div);
                    // wire the detail button for this report to open a separate page
                    const btn = div.querySelector('.open-detail');
                    if(btn){ btn.addEventListener('click', ()=>{ window.location.href = `/reportes/${r.id}/`; }); }
                });
            } catch (e) {
                console.warn('No se pudieron renderizar reportes recientes', e);
            }
        }

// Report detail UI is now a separate page at /reportes/<id>/ (uses template ValidacionyComentariosReportes.html)
// The in-page modal overlay was removed to avoid duplicate UI and simplify navigation.

        // Controles personalizados
        document.getElementById('zoom-in').addEventListener('click', function() {
            map.zoomIn();
        });

        document.getElementById('zoom-out').addEventListener('click', function() {
            map.zoomOut();
        });

        document.getElementById('locate-me').addEventListener('click', function() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    map.setView([lat, lng], 16);

                    L.marker([lat, lng])
                        .addTo(map)
                        .bindPopup('Tu ubicación actual')
                        .openPopup();
                }, function(error) {
                    alert('No se pudo obtener tu ubicación');
                });
            } else {
                alert('Geolocalización no soportada');
            }
        });

        // Polling configuration (milliseconds)
        const POLL_INTERVAL = 20000; // 20s default; adjust as needed
        let pollTimer = null;

        // Start / stop polling depending on page visibility
        function startPolling() {
            if (pollTimer) return;
            pollTimer = setInterval(async () => {
                await loadReportMarkers();
                await renderRecentReports();
            }, POLL_INTERVAL);
        }
        function stopPolling() {
            if (!pollTimer) return;
            clearInterval(pollTimer);
            pollTimer = null;
        }

        // Inicializar todo cuando se carga la página
        document.addEventListener('DOMContentLoaded', function() {
            loadGeoJSON();
            createLegend();
            loadReportMarkers();
            renderRecentReports();

            const btn = document.getElementById('report-new-btn');
            if (btn) btn.addEventListener('click', () => { window.location.href = '/reporte/form/'; });

            // start polling
            startPolling();
        });

        // Pause polling when page is hidden (tabs/background) to save resources
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) stopPolling(); else startPolling();
        });

        // Asegurar que el mapa se renderice correctamente
        setTimeout(function() {
            map.invalidateSize();
        }, 100);
    </script>
        <!-- Notifications/Profile scripts (shared with admin panel) -->
        <script>
        // reuse small parts of the admin panel scripts (whoami, notificaciones, profile modals)
        async function fetchWhoami(){
            try{ const res = await fetch('/api/whoami/'); if(!res.ok) return; const data = await res.json(); if(data.ok){ const pu = document.getElementById('profile-username'); const pe = document.getElementById('profile-email'); const pp = document.getElementById('profile-photo'); if(pu) pu.textContent = data.username || data.email || 'Usuario'; if(pe) pe.textContent = data.email || ''; if(pp && data.photo_url) pp.style.backgroundImage = `url(${data.photo_url})`; if(data.role === 'admin'){ const bap = document.getElementById('btn-admin-panel'); if(bap) bap.classList.remove('hidden'); } } }catch(e){console.error(e)}
        }
        async function loadNotifications(){ try{ const res = await fetch('/api/notificaciones/'); if(!res.ok) return; const d = await res.json(); const list = document.getElementById('notif-list'); list.innerHTML = ''; let unread = 0; (d.notificaciones || []).forEach(n=>{ const div = document.createElement('div'); div.className = 'p-2 cursor-pointer hover:bg-gray-50'; div.dataset.id = n.id; div.innerHTML = `<div class="font-medium text-sm">${n.titulo}</div><div class="text-xs text-gray-500">${n.resumen}</div>`; if(!n.leida) unread += 1; div.onclick = async ()=>{ await fetch(`/api/notificaciones/${n.id}/leer/`, {method:'POST', headers: {'X-CSRFToken': getCookie('csrftoken')}}); const rr = await fetch(`/api/notificaciones/${n.id}/detail/`); if(!rr.ok) return alert('No se pudo cargar la notificación'); const detail = await rr.json(); alert(detail.titulo + '\n\n' + detail.cuerpo); loadNotifications(); }; list.appendChild(div); }); const badge = document.getElementById('notif-badge'); if(unread>0){ badge.textContent = unread; badge.classList.remove('hidden'); } else { badge.classList.add('hidden'); } }catch(e){console.error('load notis',e)} }
        document.addEventListener('click', (ev)=>{ const btn = document.getElementById('btn-notifications'); const dropdown = document.getElementById('dropdown-notifications'); if(btn && btn.contains(ev.target)){ dropdown.classList.toggle('hidden'); if(!dropdown.classList.contains('hidden')) loadNotifications(); return; } if(dropdown && !dropdown.contains(ev.target)) dropdown.classList.add('hidden'); const pbtn = document.getElementById('btn-profile'); const pdrop = document.getElementById('dropdown-profile'); if(pbtn && pbtn.contains(ev.target)){ pdrop.classList.toggle('hidden'); return; } if(pdrop && !pdrop.contains(ev.target)) pdrop.classList.add('hidden'); });
        fetchWhoami();
        </script>
            <!-- Profile/Notification modals appended -->
            <script>
            // notification detail modal
            const notifModalHtml = `
    <div id="notif-modal" class="fixed inset-0 z-60 hidden items-center justify-center bg-black bg-opacity-50">
        <div class="bg-white rounded-lg w-11/12 max-w-2xl p-4 shadow-lg border border-gray-200">
            <div class="flex justify-between items-start">
                <h3 id="notif-modal-title" class="text-lg font-semibold">Notificación</h3>
                <button id="notif-modal-close" class="text-gray-500">Cerrar</button>
            </div>
            <div class="mt-3" id="notif-modal-body"></div>
        </div>
    </div>
    `;
            document.body.insertAdjacentHTML('beforeend', notifModalHtml);

            // profile view/edit modal (view includes edit controls)
            const profileModalHtml = `
    <div id="profile-modal" class="fixed inset-0 z-60 hidden items-center justify-center bg-black bg-opacity-50">
        <div class="bg-white rounded-lg w-11/12 max-w-md p-4 shadow-lg border border-gray-200">
            <div class="flex justify-between items-start">
                <h3 class="text-lg font-semibold">Perfil</h3>
                <button id="profile-modal-close" class="text-gray-500">Cerrar</button>
            </div>
            <div class="mt-3 flex flex-col items-center gap-3">
                <div id="profile-modal-photo" class="w-28 h-28 rounded-full bg-center bg-cover"></div>
                <div id="profile-modal-username" class="font-bold text-lg">Usuario</div>
                <div id="profile-modal-email" class="text-sm text-gray-500">email@example.com</div>
                <div class="w-full mt-2">
                    <label class="text-sm font-medium">Editar nombre</label>
                    <input id="profile-modal-edit-username" class="block w-full mt-1 rounded border-gray-200" />
                </div>
                <div class="w-full">
                    <label class="text-sm font-medium">Cambiar foto</label>
                    <input id="profile-modal-edit-photo" type="file" accept="image/*" class="block mt-1" />
                </div>
                <div class="w-full flex justify-end">
                    <button id="profile-modal-save" class="inline-flex items-center justify-center rounded-md border border-transparent bg-[var(--primary-color)] px-4 py-2 text-sm font-medium text-white">Guardar</button>
                </div>
            </div>
        </div>
    </div>
    `;
            document.body.insertAdjacentHTML('beforeend', profileModalHtml);

            // handlers for modals
            document.getElementById('notif-list').addEventListener('click', async (ev)=>{ let el = ev.target; while(el && !el.dataset.id) el = el.parentElement; if(!el||!el.dataset.id) return; const id = el.dataset.id; await fetch(`/api/notificaciones/${id}/leer/`, {method:'POST', headers: {'X-CSRFToken': getCookie('csrftoken')}}); const rr = await fetch(`/api/notificaciones/${id}/detail/`); if(!rr.ok) return alert('No se pudo cargar la notificación'); const detail = await rr.json(); document.getElementById('notif-modal-title').textContent = detail.titulo || ''; document.getElementById('notif-modal-body').textContent = detail.cuerpo || ''; document.getElementById('notif-modal').classList.remove('hidden'); document.getElementById('notif-modal').classList.add('flex'); loadNotifications(); });
            document.getElementById('notif-modal-close').addEventListener('click', ()=>{ const m = document.getElementById('notif-modal'); m.classList.remove('flex'); m.classList.add('hidden'); });

            document.getElementById('btn-view-profile').addEventListener('click', async ()=>{ const m = document.getElementById('profile-modal'); document.getElementById('profile-modal-username').textContent = document.getElementById('profile-username').textContent; document.getElementById('profile-modal-email').textContent = document.getElementById('profile-email').textContent; const bg = document.getElementById('profile-photo').style.backgroundImage; document.getElementById('profile-modal-photo').style.backgroundImage = bg; document.getElementById('profile-modal-edit-username').value = document.getElementById('profile-username').textContent || ''; m.classList.remove('hidden'); m.classList.add('flex'); });
            document.getElementById('profile-modal-close').addEventListener('click', ()=>{ const m = document.getElementById('profile-modal'); m.classList.remove('flex'); m.classList.add('hidden'); });
            document.getElementById('profile-modal-save').addEventListener('click', async ()=>{ const fd = new FormData(); const name = document.getElementById('profile-modal-edit-username').value; if(name) fd.append('username', name); const photo = document.getElementById('profile-modal-edit-photo').files[0]; if(photo) fd.append('photo', photo); const res = await fetch('/api/profile/update/', {method:'POST', headers: {'X-CSRFToken': getCookie('csrftoken')}, body: fd}); if(res.ok){ const d = await res.json(); if(d.photo_url) document.getElementById('profile-photo').style.backgroundImage = `url(${d.photo_url})`; document.getElementById('profile-username').textContent = d.username; alert('Perfil actualizado'); const m = document.getElementById('profile-modal'); m.classList.remove('flex'); m.classList.add('hidden'); } else alert('Error al guardar'); });
            // fetch whoami initially
                fetchWhoami();
                // logout button handler
                const logoutBtn = document.getElementById('btn-logout');
                if(logoutBtn) logoutBtn.addEventListener('click', ()=>{ window.location.href = '/logout/'; });
            </script>
</body>
</html>