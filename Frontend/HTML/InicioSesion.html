{% load static %}
<html><head>
<meta charset="utf-8"/>
<link crossorigin="" href="https://fonts.gstatic.com/" rel="preconnect"/>
<link as="style" href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&amp;display=swap" onload="this.rel='stylesheet'" rel="stylesheet"/>
<title>Inicio de Sesión- SECUSEO</title>
<link href="{% static 'HTML/Logo.png' %}" rel="icon" type="image/png"/>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<style type="text/tailwindcss">
      :root {
        --primary-color: #545dfa;--secondary-color: #f1f2ff;--accent-color: #545dfa;
        --text-color: #1a202c;
        --background-color: #f1f2ff;
      }
      body {
        font-family: 'Poppins', sans-serif;
        background-color: var(--background-color);
        background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23e6e6e6' fill-opacity='0.4'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
      }
      .form-input {
        border: 1px solid #cbd5e1;
        transition: border-color 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
      }
      .form-input:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 2px rgba(13, 71, 161, 0.2);
        outline: none;
      }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen">
<div class="w-full max-w-md p-8 space-y-6 bg-white shadow-2xl rounded-2xl">
<div class="flex justify-center">
<img alt="SECUSEO Logo" class="h-16 w-auto" src="{% static 'HTML/Logo.png' %}"/>
</div>
<h2 class="text-3xl font-bold text-center text-[var(--text-color)]">Bienvenido a SECUSEO</h2>
<p class="text-center text-gray-500">Reporta y visualiza zonas peligrosas en Funza.</p>
<div class="space-y-6" x-data="{ isLogin: true }">
<div class="flex border-b border-gray-200">
<button :class="isLogin ? 'border-b-2 border-[var(--primary-color)] text-[var(--primary-color)]' : 'text-gray-500'" @click="isLogin = true" class="flex-1 py-2 font-medium text-center transition-colors">Iniciar Sesión</button>
<button :class="!isLogin ? 'border-b-2 border-[var(--primary-color)] text-[var(--primary-color)]' : 'text-gray-500'" @click="isLogin = false" class="flex-1 py-2 font-medium text-center transition-colors">Registrarse</button>
</div>
<form action="/login/" method="post" class="space-y-6" x-show="isLogin">
<div>
<label class="text-sm font-medium text-gray-700 sr-only" for="login-email">Correo electrónico</label>
<input class="form-input w-full px-4 py-3 rounded-lg text-base" id="login-email" placeholder="Correo electrónico" required="" type="email"/>
</div>
<div>
<label class="text-sm font-medium text-gray-700 sr-only" for="login-password">Contraseña</label>
<input class="form-input w-full px-4 py-3 rounded-lg text-base" id="login-password" placeholder="Contraseña" required="" type="password"/>
</div>
<div>
<button class="w-full px-4 py-3 font-semibold text-white bg-[var(--primary-color)] rounded-lg hover:bg-[var(--accent-color)] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[var(--primary-color)] transition-colors duration-300" type="submit">Ingresar</button>
</div>
  {% csrf_token %}
</form>

<form action="/login/" method="post" class="space-y-6" style="display: none;" x-show="!isLogin">
  {% csrf_token %}
<div>
<label class="text-sm font-medium text-gray-700 sr-only" for="register-name">Nombre completo</label>
<input class="form-input w-full px-4 py-3 rounded-lg text-base" id="register-name" placeholder="Nombre completo" required="" type="text"/>
</div>
<div>
<label class="text-sm font-medium text-gray-700 sr-only" for="register-email">Correo electrónico</label>
<input class="form-input w-full px-4 py-3 rounded-lg text-base" id="register-email" placeholder="Correo electrónico" required="" type="email"/>
</div>
<div>
<label class="text-sm font-medium text-gray-700 sr-only" for="register-password">Contraseña</label>
<input class="form-input w-full px-4 py-3 rounded-lg text-base" id="register-password" placeholder="Contraseña" required="" type="password"/>
</div>
<div>
<label class="text-sm font-medium text-gray-700 sr-only" for="register-telefono">Teléfono</label>
<input class="form-input w-full px-4 py-3 rounded-lg text-base" id="register-telefono" placeholder="Teléfono (ej: +573001112233)" required="" type="tel"/>
</div>
<div>
<label class="text-sm font-medium text-gray-700 sr-only" for="register-dob">Fecha de Nacimiento</label>
<input class="form-input w-full px-4 py-3 rounded-lg text-base text-gray-500" id="register-dob" onblur="(this.type='text')" onfocus="(this.type='date')" placeholder="Fecha de Nacimiento" required="" type="text"/>
</div>
<div>
<button class="w-full px-4 py-3 font-semibold text-white bg-[var(--primary-color)] rounded-lg hover:bg-[var(--accent-color)] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[var(--primary-color)] transition-colors duration-300" type="submit">Registrarse</button>
</div>
</form>
<div class="text-center">
<a class="text-sm font-medium text-[var(--primary-color)] hover:underline" href="#">¿Olvidaste tu contraseña?</a>
</div>
</div>
</div>
<script defer="" src="https://cdn.jsdelivr.net/gh/alpinejs/alpine@v2.x.x/dist/alpine.min.js"></script>

<script>
// CSRF helper
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

document.addEventListener('DOMContentLoaded', function(){
  const loginForm = document.querySelector('form[x-show="isLogin"]');
  const registerForm = document.querySelector('form[x-show="!isLogin"]');

  // helper to show alert messages
  function showAlert(msg) {
    alert(msg);
  }

  if (loginForm) {
    loginForm.addEventListener('submit', async function(e){
      e.preventDefault();
      const email = document.getElementById('login-email').value;
      const password = document.getElementById('login-password').value;
      const fd = new FormData();
      fd.append('action','login');
      fd.append('email', email);
      fd.append('password', password);
      try {
        const res = await fetch('/login/', { method: 'POST', headers: {'X-CSRFToken': getCookie('csrftoken')}, body: fd });
        const data = await res.json();
        if (!res.ok || !data.ok) {
          showAlert(data.error || 'No se pudo iniciar sesión');
          return;
        }
        // redirect according to server
        if (data.redirect) window.location.href = data.redirect;
      } catch (err) { showAlert('Error de red'); }
    });
  }

  if (registerForm) {
    registerForm.addEventListener('submit', async function(e){
      e.preventDefault();
      const name = document.getElementById('register-name').value;
      const email = document.getElementById('register-email').value;
      const password = document.getElementById('register-password').value;
      const telefono = document.getElementById('register-telefono').value;
      const dob = document.getElementById('register-dob').value;
      const fd = new FormData();
      fd.append('action','register');
      fd.append('name', name);
      fd.append('email', email);
      fd.append('password', password);
      fd.append('telefono', telefono);
      fd.append('dob', dob);
      try {
        const res = await fetch('/login/', { method: 'POST', headers: {'X-CSRFToken': getCookie('csrftoken')}, body: fd });
        const data = await res.json();
        if (!res.ok || !data.ok) {
          showAlert(data.error || 'No se pudo registrar');
          return;
        }
        // If server asks for verification, show OTP prompt
        if (data.verify_user_id) {
          const code = prompt('Ingresa el código enviado al teléfono' + (data.debug_code ? (' (debug: ' + data.debug_code + ')') : ''));
          if (!code) { showAlert('Código requerido'); return; }
          const vfd = new FormData();
          vfd.append('user_id', data.verify_user_id);
          vfd.append('code', code);
          const vres = await fetch('/verify-phone/', { method: 'POST', headers: {'X-CSRFToken': getCookie('csrftoken')}, body: vfd });
          const vdata = await vres.json();
          if (!vres.ok || !vdata.ok) { showAlert(vdata.error || 'Verificación fallida'); return; }
          // verification success: redirect to home
          window.location.href = '/';
          return;
        }
        if (data.redirect) window.location.href = data.redirect;
      } catch (err) { showAlert('Error de red'); }
    });
  }
  
  // Ensure csrftoken cookie exists for AJAX: if template rendered a csrf hidden input, copy its value into a cookie
  try {
    if (!getCookie('csrftoken')) {
      const csrfInput = document.querySelector('input[name="csrfmiddlewaretoken"]');
      if (csrfInput && csrfInput.value) {
        document.cookie = 'csrftoken=' + encodeURIComponent(csrfInput.value) + ';path=/';
      }
    }
  } catch (e) {
    // noop
  }
});
</script>

</body></html>